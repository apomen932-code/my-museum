<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Entrance</title>
<style>
    /* === ÂÖ±ÈÄöË®≠ÂÆö === */
    body { margin: 0; padding: 0; font-family: "YuMincho", "Hiragino Mincho ProN", serif; background-color: #000; color: #fff; overflow: hidden; height: 100vh; width: 100vw; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
    .fade-in { animation: fadeIn 0.5s ease forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spinSlow { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }

    /* === 1. „ÉÄ„Éü„ÉºÁîªÈù¢ (‰øÆÊ≠£Áâà: „Éü„É•„Éº„Ç∏„Ç¢„É†È¢®) === */
    #dummy-screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        /* Êöó„ÅÑÊú®ÁõÆË™ø„Å®„Çπ„Éù„ÉÉ„Éà„É©„Ç§„Éà */
        background: 
            radial-gradient(circle at center, transparent 0%, #000 90%),
            repeating-linear-gradient(45deg, #1a1008 0px, #1a1008 10px, #140c06 10px, #140c06 20px);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        z-index: 9999; transition: opacity 0.8s ease;
    }
    
    .museum-sign {
        font-family: "Times New Roman", serif;
        color: #c5a059;
        font-size: 12px;
        letter-spacing: 0.3em;
        margin-bottom: 20px;
        text-shadow: 0 2px 10px rgba(0,0,0,0.8);
        border-bottom: 1px solid #5e4d1a;
        padding-bottom: 5px;
    }

    .phone-body {
        width: 220px; /* Â∞è„Åï„Åè„Åó„Åæ„Åó„Åü */
        background: linear-gradient(145deg, #222, #111);
        border-radius: 12px;
        padding: 20px 15px;
        box-shadow: 
            0 20px 50px rgba(0,0,0,1),
            inset 0 1px 0 rgba(255,255,255,0.1),
            0 0 0 1px #333;
        border: 1px solid #000;
        display: flex; flex-direction: column; align-items: center;
    }

    .phone-display-container {
        width: 100%; height: 40px;
        background: #000; border: 1px solid #444; border-radius: 4px; margin-bottom: 15px;
        display: flex; align-items: center; justify-content: center;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.8);
    }
    .phone-display-text { font-family: monospace; color: #d4af37; font-size: 20px; letter-spacing: 3px; }

    .phone-keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; }
    .phone-key {
        width: 50px; height: 50px; /* Â∞è„Åï„Åè */
        border-radius: 50%; background: linear-gradient(145deg, #1f1f1f, #141414); border: 1px solid #333;
        color: #aaa; font-family: "Times New Roman", serif; font-size: 18px;
        display: flex; align-items: center; justify-content: center; margin: 0 auto;
        cursor: pointer; box-shadow: 0 3px 5px rgba(0,0,0,0.5);
    }
    .phone-key:active { transform: scale(0.95); background: #000; color: #d4af37; }
    .phone-key.call-btn { grid-column: 2; background: linear-gradient(145deg, #8a7024, #5e4d1a); color: #fff; border: 1px solid #d4af37; }

    /* === „Ç¢„Éó„É™„Ç≥„É≥„ÉÜ„Éä === */
    #app-container { display: none; height: 100%; width: 100%; }

    /* === „Éò„ÉÉ„ÉÄ„Éº & „Éä„Éì === */
    .app-header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .header-center { text-align: center; width: 60%; }
    .app-header h1 { font-family: "Times New Roman", serif; font-size: 18px; color: #d4af37; letter-spacing: 0.1em; margin: 0; }
    .app-header .subtitle { font-family: "Times New Roman", serif; font-size: 8px; color: #888; letter-spacing: 0.2em; text-transform: uppercase; }
    .header-btn { position: absolute; top: 0; height: 60px; width: 60px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #d4af37; cursor: pointer; z-index: 1100; }
    .header-btn.left { left: 0; }
    .header-btn.right { right: 0; }

    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: #000; border-top: 1px solid #333; display: flex; justify-content: space-around; align-items: center; padding-bottom: constant(safe-area-inset-bottom); padding-bottom: env(safe-area-inset-bottom); z-index: 1500; }
    .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 10px; transition: color 0.3s; }
    .nav-item.active { color: #d4af37; }
    .nav-icon { font-size: 20px; margin-bottom: 4px; }

    /* === „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ === */
    .tab-content { display: none; height: 100%; width: 100%; box-sizing: border-box; padding-top: 60px; padding-bottom: 80px; overflow-y: auto; flex-direction: column; }
    
    /* Home Utils */
    .mode-switch-container { display: flex; justify-content: center; padding: 15px 0; gap: 20px; }
    .mode-btn { font-size: 12px; color: #666; border-bottom: 2px solid transparent; padding-bottom: 5px; cursor: pointer; transition: 0.3s; letter-spacing: 0.1em; }
    .mode-btn.active { color: #d4af37; border-bottom: 2px solid #d4af37; font-weight: bold; }

    .search-area-wrapper { padding: 0 20px 10px; display: flex; gap: 10px; align-items: center; }
    .search-input { flex-grow: 1; padding: 10px; border-radius: 8px; border: 1px solid #333; background: rgba(255,255,255,0.1); color: #fff; font-size: 14px; outline: none; }
    .icon-btn { width: 40px; height: 38px; border-radius: 8px; border: 1px solid #333; background: rgba(255,255,255,0.1); color: #ccc; font-size: 16px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .icon-btn.active { background: #d4af37; color: #000; }

    .section-title { color: #888; font-size: 11px; margin: 20px 20px 10px; letter-spacing: 0.1em; font-family: "Times New Roman", serif; }

    /* Lists & Cards */
    .card-list { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 0 20px; padding-bottom: 120px; }
    
    .card { background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 8px; overflow: hidden; position: relative; transition: transform 0.1s; }
    .card:active { transform: scale(0.96); border-color: #d4af37; }
    .card.pressing { transform: scale(0.95); border-color: #ff4444; } /* ÂâäÈô§„ÉªÁ∑®ÈõÜÊôÇ„ÅÆÂèçÂøú */
    .card.hof { border-color: #d4af37; box-shadow: 0 0 10px rgba(212, 175, 55, 0.2); }
    
    .card-thumb { height: 140px; background: #050505; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
    .card-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .card-crown { position: absolute; top: 5px; right: 5px; font-size: 16px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); z-index: 2; }
    
    .card-info { padding: 10px; }
    .card-name { font-size: 14px; color: #f0f0f0; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .card-sub { font-size: 10px; color: #d4af37; }

    /* Analysis Elements */
    .stats-area { margin: 0 20px 20px; padding: 15px; background: linear-gradient(135deg, rgba(212,175,55,0.1), transparent); border-left: 2px solid #d4af37; border-radius: 0 8px 8px 0; }
    .stats-value { font-size: 24px; color: #fff; }
    
    .calendar-container { margin: 0 20px 30px; background: #111; padding: 15px; border-radius: 8px; border: 1px solid #333; }
    .cal-header { display: flex; justify-content: space-between; margin-bottom: 10px; color: #d4af37; font-family: serif; }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
    .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #444; border-radius: 2px; }
    .cal-day.active { background: rgba(212, 175, 55, 0.3); color: #fff; border: 1px solid rgba(212,175,55,0.5); }
    .cal-day.today { border: 1px solid #666; }

    .tag-bar { display: flex; align-items: center; margin-bottom: 6px; padding: 0 20px; }
    .tag-label { width: 70px; font-size: 11px; color: #ccc; text-align: right; padding-right: 10px; }
    .tag-track { flex-grow: 1; background: #222; height: 4px; border-radius: 2px; }
    .tag-fill { height: 100%; background: #d4af37; border-radius: 2px; }
    .tag-val { width: 25px; font-size: 10px; color: #888; margin-left: 8px; }

    /* The QUEEN */
    .champion-area { margin: 0 20px 30px; display: none; }
    .champion-box { position: relative; background: #080808; border: 1px solid #d4af37; border-radius: 12px; padding: 30px 20px; text-align: center; overflow: hidden; }
    .champion-bg-flower { position: absolute; top: 50%; left: 50%; width: 200px; height: 200px; background: repeating-conic-gradient(from 0deg, rgba(212,175,55,0.15) 0deg 10deg, transparent 10deg 20deg); border-radius: 50%; transform: translate(-50%, -50%); animation: spinSlow 40s linear infinite; pointer-events: none; }
    .champion-img-box { position: relative; width: 100px; height: 100px; margin: 0 auto 15px; }
    .champion-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid #fff; position: relative; z-index: 2; }
    .champion-crown { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); font-size: 32px; z-index: 3; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.8)); }
    .champion-name { font-size: 20px; font-weight: bold; color: #fff; margin-bottom: 5px; position: relative; z-index: 2; font-family: serif; }

    /* Gobusata */
    .gobusata-scroller { display: flex; gap: 10px; overflow-x: auto; padding: 0 20px 10px; }
    .gobusata-item { min-width: 70px; text-align: center; }
    .gobusata-img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; filter: grayscale(100%); opacity: 0.6; border: 1px solid #444; }
    .gobusata-name { font-size: 9px; color: #888; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Detail Screen */
    #detail-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2500; flex-direction: column; }
    .detail-header { height: 40vh; position: relative; overflow: hidden; border-bottom: 1px solid #333; }
    .detail-bg { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
    .detail-overlay { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, #000 10%, transparent); padding: 20px; box-sizing: border-box; }
    .detail-title { font-size: 28px; font-weight: bold; margin-bottom: 5px; text-shadow: 0 2px 5px #000; }
    .detail-meta { font-size: 12px; color: #d4af37; font-family: monospace; }
    .detail-scroll { flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; }
    
    .detail-profile { font-size: 12px; color: #ccc; line-height: 1.5; margin-bottom: 10px; }
    .tag { font-size: 10px; background: #333; color: #aaa; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-right: 4px; }
    
    .back-btn { position: absolute; top: 50px; left: 20px; z-index: 2600; width: 40px; height: 40px; background: rgba(0,0,0,0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #d4af37; font-size: 24px; cursor: pointer; border: 1px solid rgba(212,175,55,0.3); }

    /* Work Item in Detail */
    .list-item { background: #1a1a1a; padding: 10px; margin-bottom: 10px; border-radius: 6px; display: flex; align-items: center; border-left: 2px solid #333; position: relative; }
    .list-item.pressing { background: #331111; } /* Long press feedback */
    .list-item.hof { border-left-color: #d4af37; background: #222; }
    .list-thumb { width: 60px; height: 60px; object-fit: cover; margin-right: 10px; border-radius: 4px; }
    .list-info { flex-grow: 1; min-width: 0; }
    .list-title { font-size: 14px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .play-btn { width: 40px; height: 40px; background: #d4af37; color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); flex-shrink: 0; margin-left: 10px; }
    .play-btn:active { transform: scale(0.9); background: #fff; }

    /* Work Detail */
    #work-detail-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 3000; flex-direction: column; overflow-y: auto; }
    .wd-img-box { width: 100%; height: 45vh; background: #111; display: flex; align-items: center; justify-content: center; }
    .wd-img { width: 100%; height: 100%; object-fit: cover; }
    .wd-content { padding: 20px; }
    .wd-btn-row { display: flex; gap: 10px; margin-top: 20px; }
    .wd-btn { flex: 1; padding: 12px; border-radius: 6px; text-align: center; font-weight: bold; font-size: 14px; cursor: pointer; }
    .wd-btn-play { background: #d4af37; color: #000; }
    .wd-btn-link { background: #333; border: 1px solid #555; }

    /* FAB */
    .fab { position: fixed; bottom: 90px; right: 25px; width: 55px; height: 55px; background: linear-gradient(135deg, #d4af37, #aa8a2e); border-radius: 50%; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4); display: flex; align-items: center; justify-content: center; font-size: 28px; color: #000; z-index: 2700; }
    .fab:active { transform: scale(0.9); }

    /* Modals */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); z-index: 4000; align-items: center; justify-content: center; }
    .modal-content { background: #151515; border: 1px solid #d4af37; padding: 20px; width: 85%; max-height: 85vh; overflow-y: auto; border-radius: 10px; text-align: center; }
    .modal-title { color: #d4af37; margin-bottom: 20px; font-size: 16px; font-family: serif; letter-spacing: 1px; }
    
    input, textarea { width: 100%; padding: 10px; margin-bottom: 10px; background: #222; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; }
    .file-btn { display: block; padding: 10px; background: #222; border: 1px dashed #666; color: #888; border-radius: 4px; margin-bottom: 10px; font-size: 12px; }
    .preview-box { height: 150px; background: #000; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; border: 1px solid #333; }
    .preview-box img { width: 100%; height: 100%; object-fit: contain; }
    .focus-point { position: absolute; width: 20px; height: 20px; border: 2px solid #d4af37; border-radius: 50%; background: rgba(212,175,55,0.3); transform: translate(-50%, -50%); pointer-events: none; display: none; }

    .btn-row { display: flex; gap: 10px; margin-top: 10px; }
    .btn { flex: 1; padding: 10px; border-radius: 4px; border: none; font-family: serif; cursor: pointer; }
    .btn-save { background: #d4af37; color: #000; font-weight: bold; }
    .btn-cancel { background: #333; color: #ccc; }
    .btn-del { background: #500; color: #fff; font-size: 10px; margin-top: 20px; width: 100%; }

    /* Sort Menu */
    .sort-menu { display: none; position: absolute; top: 50px; right: 20px; background: #222; border: 1px solid #555; border-radius: 6px; z-index: 2000; }
    .sort-item { padding: 10px 20px; font-size: 12px; border-bottom: 1px solid #333; }
    .sort-item:last-child { border: none; }

    /* Toast */
    #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background: rgba(0,0,0,0.9); border: 1px solid #d4af37; padding: 15px 30px; border-radius: 6px; color: #d4af37; pointer-events: none; opacity: 0; transition: 0.3s; z-index: 9999; text-align: center; }
    #toast.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }

    /* HOF Toggle */
    .hof-toggle { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 10px 0; font-size: 12px; color: #ccc; cursor: pointer; }
    .crown-icon { font-size: 16px; filter: grayscale(100%); }
    .crown-icon.active { filter: grayscale(0%); text-shadow: 0 0 5px gold; }

</style>
</head>
<body>

<div id="toast">RECORDED<br><span style="font-size:10px; color:#fff;">Ë≥¢ËÄÖ„Çø„Ç§„É†„Å´ÂÖ•„Çä„Åæ„Åô</span></div>

<div id="dummy-screen">
    <div class="museum-sign">MUSEUM ARCHIVES</div>
    <div class="phone-body">
        <div class="phone-display-container">
            <div class="phone-display-text" id="phone-display">----</div>
        </div>
        <div class="phone-keypad">
            <div class="phone-key" onclick="pressKey('1')">1</div>
            <div class="phone-key" onclick="pressKey('2')">2</div>
            <div class="phone-key" onclick="pressKey('3')">3</div>
            <div class="phone-key" onclick="pressKey('4')">4</div>
            <div class="phone-key" onclick="pressKey('5')">5</div>
            <div class="phone-key" onclick="pressKey('6')">6</div>
            <div class="phone-key" onclick="pressKey('7')">7</div>
            <div class="phone-key" onclick="pressKey('8')">8</div>
            <div class="phone-key" onclick="pressKey('9')">9</div>
            <div class="phone-key" onclick="clearPhone()">C</div>
            <div class="phone-key" onclick="pressKey('0')">0</div>
            <div class="phone-key call-btn" onclick="callApp()">üìû</div>
        </div>
    </div>
</div>

<div id="app-container">
    
    <header class="app-header">
        <div class="header-btn left" onclick="openSettings()">‚öô</div>
        <div class="header-center" id="panic-btn">
            <div class="subtitle">PRIVATE COLLECTION</div>
            <h1>MUSEUM</h1>
        </div>
        <div class="header-btn right" onclick="randomPick()">üîÄ</div>
    </header>

    <div id="home-screen" class="tab-content">
        <div class="mode-switch-container">
            <div class="mode-btn active" id="btn-mode-people" onclick="switchHomeMode('people')">MUSE</div>
            <div class="mode-btn" id="btn-mode-works" onclick="switchHomeMode('works')">LIBRARY</div>
        </div>
        <div class="search-area-wrapper">
            <input type="search" class="search-input" id="search-input" placeholder="Search..." oninput="filterHome()">
            <div class="icon-btn" onclick="toggleSort('home')">‚áÖ</div>
        </div>
        
        <div class="sort-menu" id="sort-menu-home">
            <div class="sort-item" onclick="setSort('count', 'home')">Count</div>
            <div class="sort-item" onclick="setSort('newest', 'home')">Newest</div>
            <div class="sort-item" onclick="setSort('rating', 'home')">Rating/HOF</div>
        </div>

        <div class="section-title" id="home-title">MUSE LIST</div>
        <div class="card-list" id="home-list"></div>
        <div class="fab" onclick="addPerson()">Ôºã</div>
    </div>

    <div id="analysis-screen" class="tab-content">
        <div class="stats-area">
            <div class="stats-title">TOTAL SELECTIONS</div>
            <div class="stats-value" id="total-count">0<span class="stats-unit">times</span></div>
        </div>
        
        <div class="section-title" style="margin-top:0;">ACTIVITY</div>
        <div class="calendar-container">
            <div class="cal-header"><div id="cal-label"></div></div>
            <div class="cal-grid" id="cal-grid"></div>
        </div>

        <div class="champion-area" id="champion-area"></div>
        
        <div class="gobusata-area" id="gobusata-area">
            <div class="section-title">LONG TIME NO SEE</div>
            <div class="gobusata-scroller" id="gobusata-list"></div>
        </div>
        
        <div class="section-title">TOP RANKING</div>
        <div class="ranking-list" id="ranking-list"></div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="navTo('home')">
            <div class="nav-icon">üèõÔ∏è</div><div>MUSEUM</div>
        </div>
        <div class="nav-item" onclick="navTo('analysis')">
            <div class="nav-icon">üìä</div><div>ANALYSIS</div>
        </div>
    </nav>
</div>

<div id="detail-screen">
    <div class="back-btn" onclick="closeDetail()">‚Üê</div>
    <div class="detail-header">
        <img id="d-bg" class="detail-bg">
        <div class="detail-overlay">
            <div class="detail-name" id="d-name">Name</div>
            <div class="detail-specs" id="d-specs"></div>
            <div class="detail-stats" id="d-stats">Selection: 0</div>
            <div class="person-profile-text" id="d-profile"></div>
            <div class="person-tags-area" id="d-tags"></div>
        </div>
    </div>
    <div class="detail-sticky-bar">
        <div class="section-title" style="margin:0;">WORKS</div>
        <div class="icon-btn" style="width:30px; height:30px;" onclick="toggleSort('detail')">‚áÖ</div>
    </div>
    <div class="sort-menu" id="sort-menu-detail" style="top:50vh; right:20px;">
        <div class="sort-item" onclick="setSort('count', 'detail')">Count</div>
        <div class="sort-item" onclick="setSort('newest', 'detail')">Newest</div>
        <div class="sort-item" onclick="setSort('rating', 'detail')">Rating</div>
    </div>

    <div class="detail-scroll-area">
        <div id="detail-work-list" style="padding: 0 20px 100px 20px;"></div>
    </div>
    <div class="fab" onclick="addWork()">Ôºã</div>
</div>

<div id="work-detail-screen">
    <div class="back-btn" onclick="closeWorkDetail()">‚Üì</div>
    <div class="wd-img-box">
        <img id="wd-img" class="wd-img">
        <div id="wd-no-img" style="color:#666; font-size:12px;">NO IMAGE</div>
    </div>
    <div class="wd-content">
        <div class="wd-title" id="wd-title">Title</div>
        <div class="wd-meta" id="wd-meta"></div>
        <div class="wd-tags" id="wd-tags" style="display:flex; gap:5px; flex-wrap:wrap; margin-top:10px;"></div>
        <div class="wd-btn-row">
            <div class="wd-btn wd-btn-link" id="wd-link" onclick="">LINK</div>
            <div class="wd-btn wd-btn-play" id="wd-play" onclick="">PLAY</div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-person">
    <div class="modal-content">
        <div class="modal-title">EDIT MUSE</div>
        <input type="hidden" id="p-id">
        <input type="text" id="p-name" placeholder="Name">
        <div style="display:flex; gap:10px;">
            <input type="text" id="p-cup" placeholder="Cup" style="flex:1;">
            <input type="date" id="p-bday" style="flex:2;">
        </div>
        <div class="hof-toggle" onclick="toggleHof('p-hof', 'p-hof-icon')">
            <span class="crown-icon" id="p-hof-icon">üëë</span> Hall of Fame
            <input type="checkbox" id="p-hof" style="display:none;">
        </div>
        <textarea id="p-profile" placeholder="Profile/Memo"></textarea>
        <input type="text" id="p-tags" placeholder="Tags (space separated)">
        
        <label class="file-btn">Choose Image <input type="file" onchange="previewFile(this, 'p-preview', 'p-focus')"></label>
        <div class="preview-box" onclick="setFocus(event, 'p-preview', 'p-focus')">
            <img id="p-preview" style="display:none;">
            <div id="p-focus" class="focus-point"></div>
            <div style="color:#666; font-size:10px;">Tap to set focus</div>
        </div>

        <div class="btn-row">
            <button class="btn btn-cancel" onclick="closeModal('modal-person')">CANCEL</button>
            <button class="btn btn-save" onclick="submitPerson()">SAVE</button>
        </div>
        <button class="btn btn-del" id="p-del-btn" onclick="deletePerson()">DELETE</button>
    </div>
</div>

<div class="modal-overlay" id="modal-work">
    <div class="modal-content">
        <div class="modal-title">EDIT WORK</div>
        <input type="hidden" id="w-id">
        <input type="text" id="w-title" placeholder="Title">
        <input type="url" id="w-url" placeholder="URL">
        
        <div class="hof-toggle" onclick="toggleHof('w-hof', 'w-hof-icon')">
            <span class="crown-icon" id="w-hof-icon">üëë</span> Hall of Fame
            <input type="checkbox" id="w-hof" style="display:none;">
        </div>
        
        <input type="text" id="w-tags" placeholder="Tags">
        
        <label class="file-btn">Choose Thumbnail <input type="file" onchange="previewFile(this, 'w-preview', 'w-focus')"></label>
        <div class="preview-box" onclick="setFocus(event, 'w-preview', 'w-focus')">
            <img id="w-preview" style="display:none;">
            <div id="w-focus" class="focus-point"></div>
        </div>

        <div class="btn-row">
            <button class="btn btn-cancel" onclick="closeModal('modal-work')">CANCEL</button>
            <button class="btn btn-save" onclick="submitWork()">SAVE</button>
        </div>
        <button class="btn btn-del" id="w-del-btn" onclick="deleteWork()">DELETE</button>
    </div>
</div>

<div class="modal-overlay" id="modal-settings">
    <div class="modal-content">
        <div class="modal-title">SETTINGS</div>
        <button class="btn btn-save" style="margin-bottom:10px;" onclick="backupData()">BACKUP</button>
        <label class="btn btn-cancel" style="display:block; margin-bottom:10px;">
            RESTORE
            <input type="file" style="display:none;" onchange="restoreData(this)">
        </label>
        <button class="btn btn-cancel" onclick="closeModal('modal-settings')">CLOSE</button>
        <button class="btn btn-del" onclick="wipeData()">RESET ALL DATA</button>
    </div>
</div>

<script>
// ====================
// 1. CORE & UTILS
// ====================
const CODE = '4519';
let db;
let currentPersonId = null;
let homeMode = 'people'; // 'people' or 'works'
let sortState = { home: 'count', detail: 'count' };
let focusTemp = { x:50, y:50 };
let inputBuffer = "";
let lastTapTime = 0;

// Panic
document.getElementById('panic-btn').addEventListener('click', (e) => {
    const now = new Date().getTime();
    if(now - lastTapTime < 300) location.reload();
    lastTapTime = now;
});

// Phone Logic
function pressKey(k) {
    if(inputBuffer.length < 4) {
        inputBuffer += k;
        if(navigator.vibrate) navigator.vibrate(20);
        updatePhone();
    }
}
function clearPhone() { inputBuffer = ""; updatePhone(); }
function updatePhone() {
    let s = ""; for(let i=0; i<4; i++) s += (i<inputBuffer.length ? "‚Ä¢" : "-");
    document.getElementById('phone-display').innerText = s;
}
function callApp() {
    if(inputBuffer === CODE) {
        if(navigator.vibrate) navigator.vibrate([50,50]);
        document.getElementById('dummy-screen').style.opacity = 0;
        setTimeout(() => {
            document.getElementById('dummy-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            navTo('home'); // Explicitly trigger init
        }, 800);
    } else {
        if(navigator.vibrate) navigator.vibrate(200);
        document.getElementById('phone-display').style.color = 'red';
        setTimeout(()=>{
            inputBuffer = ""; updatePhone();
            document.getElementById('phone-display').style.color = '#d4af37';
        }, 400);
    }
}

// DB Init
window.onload = () => {
    const req = indexedDB.open("SecretMuseumDB", 8);
    req.onupgradeneeded = (e) => {
        db = e.target.result;
        if(!db.objectStoreNames.contains("people")) db.createObjectStore("people", { keyPath:"id", autoIncrement:true });
        if(!db.objectStoreNames.contains("works")) {
            const ws = db.createObjectStore("works", { keyPath:"id", autoIncrement:true });
            ws.createIndex("personId", "personId", { unique:false });
        }
        if(!db.objectStoreNames.contains("logs")) {
            const ls = db.createObjectStore("logs", { keyPath:"id", autoIncrement:true });
            ls.createIndex("timestamp", "timestamp", { unique:false });
        }
    };
    req.onsuccess = (e) => { db = e.target.result; };
};

// ====================
// 2. NAVIGATION & HOME
// ====================
function navTo(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    
    if(tab === 'home') {
        document.getElementById('home-screen').style.display = 'flex';
        document.querySelectorAll('.nav-item')[0].classList.add('active');
        loadHomeList();
    } else {
        document.getElementById('analysis-screen').style.display = 'block';
        document.querySelectorAll('.nav-item')[1].classList.add('active');
        loadAnalysis();
    }
}

function switchHomeMode(mode) {
    homeMode = mode;
    document.getElementById('btn-mode-people').className = mode==='people'?'mode-btn active':'mode-btn';
    document.getElementById('btn-mode-works').className = mode==='works'?'mode-btn active':'mode-btn';
    document.getElementById('home-title').innerText = mode==='people'?"MUSE LIST (Hold to Edit)":"LIBRARY (Tap to Detail)";
    loadHomeList();
}

function loadHomeList() {
    const tx = db.transaction(["people", "works"], "readonly");
    const pStore = tx.objectStore("people");
    const wStore = tx.objectStore("works");
    
    // Parallel fetch
    Promise.all([
        new Promise(r => pStore.getAll().onsuccess = e => r(e.target.result)),
        new Promise(r => wStore.getAll().onsuccess = e => r(e.target.result))
    ]).then(([people, works]) => {
        const query = document.getElementById('search-input').value.toLowerCase();
        
        if(homeMode === 'people') {
            document.getElementById('home-list').style.display = 'grid';
            document.getElementById('work-list-home').style.display = 'none';
            // Filter
            const filtered = people.filter(p => p.name.toLowerCase().includes(query));
            sortItems(filtered, sortState.home);
            renderCards(filtered, 'person', 'home-list');
        } else {
            document.getElementById('home-list').style.display = 'none';
            document.getElementById('work-list-home').style.display = 'grid';
            // Filter
            const filtered = works.filter(w => w.title.toLowerCase().includes(query));
            sortItems(filtered, sortState.home);
            renderCards(filtered, 'work', 'work-list-home');
        }
    });
}

function sortItems(arr, mode) {
    if(mode === 'count') arr.sort((a,b) => (b.count||0) - (a.count||0));
    else if(mode === 'newest') arr.sort((a,b) => b.id - a.id);
    else if(mode === 'rating') {
        // HOF counts as 6 stars
        arr.sort((a,b) => {
            const va = (a.hallOfFame?6:0) + (a.rating||0);
            const vb = (b.hallOfFame?6:0) + (b.rating||0);
            return vb - va;
        });
    }
}

// ====================
// 3. RENDERING CARDS (Simple Tap/Hold Logic)
// ====================
function renderCards(items, type, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = "";
    if(items.length === 0) { container.innerHTML = "<div style='grid-column:span 2; text-align:center; color:#555;'>No Data</div>"; return; }

    items.forEach(item => {
        const div = document.createElement('div');
        div.className = type === 'person' ? 'person-card' : 'work-card';
        if(item.hallOfFame) div.classList.add('hof');
        
        let imgHtml = '<div class="thumb-placeholder">NO IMAGE</div>';
        if(item.image) {
            imgHtml = `<img src="${item.image}" style="object-position: ${item.focusX||50}% ${item.focusY||50}%">`;
        }
        let crown = item.hallOfFame ? '<div class="card-crown">üëë</div>' : '';
        let label = type==='person' ? item.name : item.title;
        
        div.innerHTML = `
            <div class="thumb-area">${imgHtml}${crown}</div>
            <div class="info-area">
                <div class="${type==='person'?'name':'work-card-title'}">${label}</div>
                <div class="count">${item.count||0} SELECTIONS</div>
            </div>
        `;

        // --- NEW TOUCH LOGIC ---
        let pressTimer = null;
        
        // Touch Start
        div.addEventListener('touchstart', (e) => {
            div.classList.add('pressing');
            pressTimer = setTimeout(() => {
                // Long Press Detected
                pressTimer = null;
                if(navigator.vibrate) navigator.vibrate(40);
                div.classList.remove('pressing');
                // Open Edit
                if(type === 'person') openEditPerson(item);
                else openEditWork(item); // Note: Home Works edit allowed here? Yes.
            }, 600);
        });

        // Touch End
        div.addEventListener('touchend', (e) => {
            div.classList.remove('pressing');
            if(pressTimer) {
                // Timer still running -> It was a short tap
                clearTimeout(pressTimer);
                pressTimer = null;
                // Go to Detail
                if(type === 'person') openDetail(item.id);
                else openWorkDetail(item);
            }
        });

        // Touch Move (Cancel)
        div.addEventListener('touchmove', () => {
            if(pressTimer) { clearTimeout(pressTimer); pressTimer = null; div.classList.remove('pressing'); }
        });

        // Click fallback for PC
        div.onclick = (e) => {
            // Only if not touch device logic (simple check)
            // But we can just leave it; touch events fire first usually.
            // To prevent double firing, we can ignore click if touch handled it.
            // Simplified: If user is on PC, touchstart won't fire.
            if(!('ontouchstart' in window)) {
                if(type === 'person') openDetail(item.id);
                else openWorkDetail(item);
            }
        };
        // Right click for edit on PC
        div.oncontextmenu = (e) => {
            e.preventDefault();
            if(type === 'person') openEditPerson(item);
            else openEditWork(item);
        }

        container.appendChild(div);
    });
}

// ====================
// 4. DETAIL SCREENS
// ====================
function openDetail(pid) {
    currentPersonId = pid;
    document.getElementById('home-screen').style.display = 'none';
    document.getElementById('detail-screen').style.display = 'flex';
    document.getElementById('detail-screen').classList.add('fade-in');
    
    // Load Person
    const tx = db.transaction(["people", "works"], "readonly");
    tx.objectStore("people").get(pid).onsuccess = (e) => {
        const p = e.target.result;
        if(!p) return;
        document.getElementById('d-name').innerText = p.name;
        document.getElementById('d-stats').innerText = `Selection: ${p.count||0}`;
        document.getElementById('d-profile').innerText = p.profile || "";
        
        // Specs
        let specs = "";
        if(p.hallOfFame) specs += `<span class="detail-spec-item" style="color:#d4af37; border-color:#d4af37;">üëë Hall of Fame</span> `;
        if(p.cup) specs += `<span class="detail-spec-item">${p.cup} cup</span> `;
        if(p.birthday) {
            const age = getAge(p.birthday);
            specs += `<span class="detail-spec-item">${age}Ê≠≥ (${p.birthday.replace(/-/g,'/')})</span>`;
        }
        document.getElementById('d-specs').innerHTML = specs;

        // Tags
        const tDiv = document.getElementById('d-tags'); tDiv.innerHTML = "";
        if(p.tags) p.tags.forEach(t => tDiv.innerHTML += `<span class="tag">${t}</span>`);
        
        // Img
        const img = document.getElementById('d-bg');
        if(p.image) { img.src = p.image; img.style.objectPosition = `${p.focusX||50}% ${p.focusY||50}%`; }
        else img.src = "";
    };
    
    loadDetailWorks();
}

function loadDetailWorks() {
    const tx = db.transaction(["works"], "readonly");
    const idx = tx.objectStore("works").index("personId");
    idx.getAll(currentPersonId).onsuccess = (e) => {
        const works = e.target.result;
        sortItems(works, sortState.detail);
        renderDetailWorkList(works);
    };
}

function renderDetailWorkList(works) {
    const con = document.getElementById('detail-work-list'); con.innerHTML = "";
    if(works.length===0) { con.innerHTML="<div style='text-align:center; color:#555; margin-top:20px;'>No Works</div>"; return; }
    
    works.forEach(w => {
        const div = document.createElement('div');
        div.className = 'list-item';
        if(w.hallOfFame) div.classList.add('hof');
        
        let thumb = "";
        if(w.image) thumb = `<img src="${w.image}" class="list-thumb" style="object-position:${w.focusX||50}% ${w.focusY||50}%">`;
        let crown = w.hallOfFame ? 'üëë ' : '';
        
        div.innerHTML = `
            ${thumb}
            <div class="list-info">
                <div class="list-title">${crown}${w.title}</div>
                <div class="work-count" id="wc-${w.id}">‚ñ∂ ${w.count||0}</div>
            </div>
            <div class="play-btn" onclick="playWork(${w.id}); event.stopPropagation();">‚ñ∂</div>
        `;
        
        // Tap/LongPress for List Item
        let pressTimer = null;
        div.addEventListener('touchstart', (e) => {
            if(e.target.classList.contains('play-btn')) return;
            div.classList.add('pressing');
            pressTimer = setTimeout(() => {
                pressTimer = null;
                if(navigator.vibrate) navigator.vibrate(40);
                div.classList.remove('pressing');
                openEditWork(w);
            }, 600);
        });
        div.addEventListener('touchend', () => {
            div.classList.remove('pressing');
            if(pressTimer) { clearTimeout(pressTimer); pressTimer = null; openWorkDetail(w); }
        });
        div.addEventListener('touchmove', () => { if(pressTimer) { clearTimeout(pressTimer); pressTimer = null; div.classList.remove('pressing'); }});
        div.onclick = (e) => { if(!('ontouchstart' in window) && !e.target.classList.contains('play-btn')) openWorkDetail(w); };

        con.appendChild(div);
    });
}

function closeDetail() {
    document.getElementById('detail-screen').style.display = 'none';
    document.getElementById('home-screen').style.display = 'flex';
    currentPersonId = null;
    loadHomeList();
}

// Work Detail
function openWorkDetail(w) {
    document.getElementById('wd-title').innerText = w.title;
    document.getElementById('wd-meta').innerText = `Selection: ${w.count||0}`;
    const tDiv = document.getElementById('wd-tags'); tDiv.innerHTML = "";
    if(w.tags) w.tags.forEach(t => tDiv.innerHTML += `<span class="tag">${t}</span>`);
    
    const img = document.getElementById('wd-img'); const noImg = document.getElementById('wd-no-img');
    if(w.image) {
        img.src = w.image; img.style.objectPosition = `${w.focusX||50}% ${w.focusY||50}%`;
        img.style.display = 'block'; noImg.style.display = 'none';
    } else {
        img.style.display = 'none'; noImg.style.display = 'block';
    }

    document.getElementById('wd-play').onclick = () => playWork(w.id);
    const link = document.getElementById('wd-link');
    if(w.url) { link.style.display = 'block'; link.onclick = () => window.open(w.url, '_blank'); }
    else { link.style.display = 'none'; }
    
    document.getElementById('work-detail-screen').style.display = 'flex';
}
function closeWorkDetail() { document.getElementById('work-detail-screen').style.display = 'none'; }

// ====================
// 5. ACTIONS (Play, Random, Sort)
// ====================
function playWork(wid) {
    // 1. Get Work to find PersonId
    const tx = db.transaction(["works", "people", "logs"], "readwrite");
    const wStore = tx.objectStore("works");
    const pStore = tx.objectStore("people");
    const lStore = tx.objectStore("logs");

    wStore.get(wid).onsuccess = (e) => {
        const w = e.target.result;
        if(!w) return;
        
        // Update Work
        w.count = (w.count||0) + 1;
        wStore.put(w);
        
        // Update Person
        pStore.get(w.personId).onsuccess = (pe) => {
            const p = pe.target.result;
            if(p) {
                p.count = (p.count||0) + 1;
                p.lastUsed = new Date();
                pStore.put(p);
                // Update UI instantly if visible
                if(currentPersonId === p.id) {
                    document.getElementById('d-stats').innerText = `Selection: ${p.count}`;
                }
            }
        };

        // Log
        lStore.add({ personId: w.personId, workId: wid, timestamp: new Date() });
    };

    tx.oncomplete = () => {
        showToast();
        // Refresh visible lists
        if(currentPersonId) loadDetailWorks();
        if(document.getElementById('work-detail-screen').style.display === 'flex') {
            document.getElementById('wd-meta').innerText = "Selection: Updated";
        }
    };
}

function randomPick() {
    const tx = db.transaction(["people"], "readonly");
    tx.objectStore("people").getAll().onsuccess = (e) => {
        const arr = e.target.result;
        if(arr.length === 0) return alert("No Muses.");
        const r = arr[Math.floor(Math.random() * arr.length)];
        openDetail(r.id);
    };
}

function toggleSort(ctx) {
    const m = document.getElementById(`sort-menu-${ctx}`);
    m.style.display = (m.style.display === 'block') ? 'none' : 'block';
}
function setSort(mode, ctx) {
    sortState[ctx] = mode;
    document.getElementById(`sort-menu-${ctx}`).style.display = 'none';
    if(ctx === 'home') loadHomeList();
    else loadDetailWorks();
}

function filterHome() { loadHomeList(); } // Simple re-trigger

// ====================
// 6. MODALS & EDITING
// ====================
function openAddPerson() {
    clearForm('person');
    document.getElementById('modal-person').style.display = 'flex';
}
function openEditPerson(p) {
    fillForm('person', p);
    document.getElementById('modal-person').style.display = 'flex';
}
function openAddWork() {
    clearForm('work');
    document.getElementById('modal-work').style.display = 'flex';
}
function openEditWork(w) {
    fillForm('work', w);
    document.getElementById('modal-work').style.display = 'flex';
}

function clearForm(type) {
    if(type==='person') {
        document.getElementById('p-id').value = "";
        document.getElementById('p-name').value = "";
        document.getElementById('p-cup').value = "";
        document.getElementById('p-bday').value = "";
        document.getElementById('p-profile').value = "";
        document.getElementById('p-tags').value = "";
        document.getElementById('p-hof').checked = false;
        toggleHofIcon('p-hof-icon', false);
        document.getElementById('p-preview').style.display = 'none';
        document.getElementById('p-del-btn').style.display = 'none';
    } else {
        document.getElementById('w-id').value = "";
        document.getElementById('w-title').value = "";
        document.getElementById('w-url').value = "";
        document.getElementById('w-tags').value = "";
        document.getElementById('w-hof').checked = false;
        toggleHofIcon('w-hof-icon', false);
        document.getElementById('w-preview').style.display = 'none';
        document.getElementById('w-del-btn').style.display = 'none';
    }
}

function fillForm(type, obj) {
    if(type==='person') {
        document.getElementById('p-id').value = obj.id;
        document.getElementById('p-name').value = obj.name;
        document.getElementById('p-cup').value = obj.cup||"";
        document.getElementById('p-bday').value = obj.birthday||"";
        document.getElementById('p-profile').value = obj.profile||"";
        document.getElementById('p-tags').value = obj.tags ? obj.tags.join(" ") : "";
        document.getElementById('p-hof').checked = !!obj.hallOfFame;
        toggleHofIcon('p-hof-icon', !!obj.hallOfFame);
        if(obj.image) {
            const img = document.getElementById('p-preview');
            img.src = obj.image; img.style.display = 'block';
            focusTemp = { x:obj.focusX||50, y:obj.focusY||50 };
            updateFocusMarker('p-focus');
        } else document.getElementById('p-preview').style.display = 'none';
        document.getElementById('p-del-btn').style.display = 'block';
    } else {
        document.getElementById('w-id').value = obj.id;
        document.getElementById('w-title').value = obj.title;
        document.getElementById('w-url').value = obj.url||"";
        document.getElementById('w-tags').value = obj.tags ? obj.tags.join(" ") : "";
        document.getElementById('w-hof').checked = !!obj.hallOfFame;
        toggleHofIcon('w-hof-icon', !!obj.hallOfFame);
        if(obj.image) {
            const img = document.getElementById('w-preview');
            img.src = obj.image; img.style.display = 'block';
            focusTemp = { x:obj.focusX||50, y:obj.focusY||50 };
            updateFocusMarker('w-focus');
        } else document.getElementById('w-preview').style.display = 'none';
        document.getElementById('w-del-btn').style.display = 'block';
    }
}

function submitPerson() {
    const id = document.getElementById('p-id').value;
    const name = document.getElementById('p-name').value;
    if(!name) return alert("Name required");
    
    const data = {
        name: name,
        cup: document.getElementById('p-cup').value,
        birthday: document.getElementById('p-bday').value,
        profile: document.getElementById('p-profile').value,
        tags: document.getElementById('p-tags').value.split(" ").filter(t=>t),
        hallOfFame: document.getElementById('p-hof').checked
    };
    const img = document.getElementById('p-preview');
    if(img.style.display === 'block' && img.src.startsWith('data:')) {
        data.image = img.src;
        data.focusX = focusTemp.x; data.focusY = focusTemp.y;
    }

    const tx = db.transaction(["people"], "readwrite");
    const store = tx.objectStore("people");

    if(id) {
        store.get(parseInt(id)).onsuccess = (e) => {
            const old = e.target.result;
            Object.assign(old, data);
            store.put(old);
        };
    } else {
        data.count = 0; data.createdAt = new Date();
        store.add(data);
    }
    tx.oncomplete = () => { closeModal('modal-person'); loadHomeList(); };
}

function submitWork() {
    if(!currentPersonId && !document.getElementById('w-id').value) return; // Should not happen
    const id = document.getElementById('w-id').value;
    const title = document.getElementById('w-title').value;
    if(!title) return alert("Title required");

    const data = {
        title: title,
        url: document.getElementById('w-url').value,
        tags: document.getElementById('w-tags').value.split(" ").filter(t=>t),
        hallOfFame: document.getElementById('w-hof').checked
    };
    const img = document.getElementById('w-preview');
    if(img.style.display === 'block' && img.src.startsWith('data:')) {
        data.image = img.src;
        data.focusX = focusTemp.x; data.focusY = focusTemp.y;
    }

    const tx = db.transaction(["works"], "readwrite");
    const store = tx.objectStore("works");

    if(id) {
        store.get(parseInt(id)).onsuccess = (e) => {
            const old = e.target.result;
            Object.assign(old, data);
            store.put(old);
        };
    } else {
        data.personId = currentPersonId;
        data.count = 0; data.createdAt = new Date();
        store.add(data);
    }
    tx.oncomplete = () => { closeModal('modal-work'); loadDetailWorks(); };
}

function deletePerson() {
    const id = document.getElementById('p-id').value;
    if(confirm("Delete this Muse?")) {
        const tx = db.transaction(["people"], "readwrite");
        tx.objectStore("people").delete(parseInt(id));
        tx.oncomplete = () => { closeModal('modal-person'); loadHomeList(); };
    }
}
function deleteWork() {
    const id = document.getElementById('w-id').value;
    if(confirm("Delete this Work?")) {
        const tx = db.transaction(["works"], "readwrite");
        tx.objectStore("works").delete(parseInt(id));
        tx.oncomplete = () => { closeModal('modal-work'); loadDetailWorks(); };
    }
}

// Utils
function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function openSettings() { document.getElementById('modal-settings').style.display = 'flex'; }
function toggleHof(inputId, iconId) {
    const cb = document.getElementById(inputId);
    cb.checked = !cb.checked;
    toggleHofIcon(iconId, cb.checked);
}
function toggleHofIcon(id, isOn) {
    const el = document.getElementById(id);
    if(isOn) el.classList.add('active'); else el.classList.remove('active');
}
function previewFile(input, imgId, focusId) {
    const f = input.files[0];
    if(f) {
        const r = new FileReader();
        r.onload = (e) => {
            document.getElementById(imgId).src = e.target.result;
            document.getElementById(imgId).style.display = 'block';
            focusTemp = {x:50, y:50};
            updateFocusMarker(focusId);
        };
        r.readAsDataURL(f);
    }
}
function setFocus(e, imgId, focusId) {
    const img = document.getElementById(imgId);
    const rect = img.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 100;
    const y = ((e.clientY - rect.top) / rect.height) * 100;
    focusTemp = {x, y};
    updateFocusMarker(focusId);
}
function updateFocusMarker(id) {
    const el = document.getElementById(id);
    el.style.left = focusTemp.x + "%";
    el.style.top = focusTemp.y + "%";
    el.style.display = 'block';
}
function showToast() {
    const t = document.getElementById('toast');
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 2000);
}
function getAge(bday) {
    const b = new Date(bday); const n = new Date();
    let a = n.getFullYear() - b.getFullYear();
    if(n.getMonth() < b.getMonth() || (n.getMonth()===b.getMonth() && n.getDate()<b.getDate())) a--;
    return a;
}

// Analysis (Simplified for this version)
function loadAnalysis() {
    // Basic stats render
    const tx = db.transaction(["logs", "people"], "readonly");
    tx.objectStore("people").getAll().onsuccess = (e) => {
        const p = e.target.result;
        let total = 0; p.forEach(x=>total+=(x.count||0));
        document.getElementById('total-count').innerText = total + " times";
        
        // Champion
        let champ = p.sort((a,b)=>(b.count||0)-(a.count||0))[0];
        if(champ && champ.count > 0) {
            const area = document.getElementById('champion-area');
            area.innerHTML = `
                <div class="champion-box" onclick="openDetail(${champ.id})">
                    <div class="champion-title">QUEEN OF THE MONTH</div>
                    <div class="champion-img-box">
                        <div class="champion-bg-flower"></div>
                        <div class="champion-crown">üëë</div>
                        <img src="${champ.image||''}" class="champion-img">
                    </div>
                    <div class="champion-name">${champ.name}</div>
                    <div class="champion-score">${champ.count} Selections</div>
                </div>`;
            area.style.display = 'block';
        }
        
        // Gobusata
        const gobusataList = document.getElementById('gobusata-list');
        gobusataList.innerHTML = "";
        const thirtyDays = new Date(); thirtyDays.setDate(thirtyDays.getDate()-30);
        const gobu = p.filter(x => !x.lastUsed || new Date(x.lastUsed) < thirtyDays);
        if(gobu.length > 0) {
            document.getElementById('gobusata-area').style.display = 'block';
            gobu.forEach(x => {
                const d = document.createElement('div'); d.className = 'gobusata-item';
                d.innerHTML = `<img src="${x.image||''}" class="gobusata-img"><div class="gobusata-name">${x.name}</div>`;
                d.onclick = () => openDetail(x.id);
                gobusataList.appendChild(d);
            });
        }
        
        // Ranking
        const rankList = document.getElementById('ranking-list');
        rankList.innerHTML = "";
        p.slice(0,5).forEach((x,i) => {
            const row = document.createElement('div'); row.className = 'rank-item';
            row.innerHTML = `<div class="rank-num">#${i+1}</div><div class="rank-name">${x.name}</div><div class="rank-count">${x.count||0}</div>`;
            rankList.appendChild(row);
        });
    };
    // Calendar is static for now in this streamlined logic, can be expanded
}
</script>
</body>
</html>
