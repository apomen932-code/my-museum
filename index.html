<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Calculator</title>
<style>
    /* === Ver 17.0 Base Styles === */
    body { margin: 0; padding: 0; font-family: "YuMincho", "Hiragino Mincho ProN", serif; background-color: #000; color: #fff; overflow: hidden; height: 100vh; width: 100vw; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
    
    /* Calculator (Ver 17.0 Original) */
    #calculator-screen { display: flex; flex-direction: column; justify-content: flex-end; height: 100%; width: 100%; padding-bottom: constant(safe-area-inset-bottom); padding-bottom: env(safe-area-inset-bottom); box-sizing: border-box; background-color: #000; z-index: 9999; position: absolute; top: 0; left: 0; transition: opacity 0.5s; }
    .calc-display { color: #fff; font-size: 80px; font-weight: 300; text-align: right; padding: 0 30px; margin-bottom: 20px; line-height: 1; }
    .calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 0 15px 30px 15px; }
    .calc-btn { background-color: #333; color: #fff; border: none; border-radius: 50%; height: 80px; width: 80px; font-size: 32px; display: flex; align-items: center; justify-content: center; margin: 0 auto; cursor: pointer; }
    .calc-btn:active { background-color: #555; }
    .calc-btn.orange { background-color: #ff9f0a; }
    .calc-btn.grey { background-color: #a5a5a5; color: #000; }
    .calc-btn.zero { grid-column: span 2; width: 100%; border-radius: 40px; padding-left: 30px; justify-content: flex-start; }

    /* App Structure */
    #app-container { display: none; height: 100%; width: 100%; }
    .app-header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .header-center { text-align: center; width: 60%; }
    .app-header h1 { font-family: "Times New Roman", serif; font-size: 20px; color: #d4af37; margin: 0; letter-spacing: 0.1em; }
    .header-btn { position: absolute; top: 0; height: 60px; width: 60px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #d4af37; cursor: pointer; }
    .header-btn.left { left: 0; } .header-btn.right { right: 0; }

    .tab-content { display: none; height: 100%; width: 100%; box-sizing: border-box; padding-top: 60px; padding-bottom: 80px; overflow-y: auto; flex-direction: column; }
    
    /* Home List (Ver 17.0 Grid) */
    .card-list { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; }
    .person-card, .folder-card { background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 8px; overflow: hidden; position: relative; }
    .person-card.hof { border: 2px solid #FFD700; box-shadow: 0 0 10px rgba(255,215,0,0.3); }
    .thumb-area { height: 140px; background: #111; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .thumb-area img { width: 100%; height: 100%; object-fit: cover; }
    .info-area { padding: 10px; }
    .name { font-size: 14px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .count { font-size: 11px; color: #d4af37; }
    .card-menu { position: absolute; top:0; right:0; width:40px; height:40px; display:flex; align-items:center; justify-content:center; z-index:10; text-shadow:0 0 5px #000; }

    /* Detail Screen (Ver 17.0) */
    #detail-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; flex-direction: column; }
    .detail-header { height: 40vh; position: relative; overflow: hidden; }
    .detail-header img { width: 100%; height: 100%; object-fit: cover; }
    .detail-info { padding: 20px; background: linear-gradient(to bottom, #111, #000); flex-grow: 1; overflow-y: auto; }
    .detail-name { font-size: 28px; font-weight: bold; margin-bottom: 10px; font-family: serif; }
    .detail-meta { font-size: 13px; color: #aaa; margin-bottom: 15px; display:flex; gap:10px; }
    .work-list { margin-top: 20px; }
    .work-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #222; }
    .work-thumb { width: 60px; height: 40px; background: #333; margin-right: 10px; object-fit: cover; }
    .work-title { flex-grow: 1; font-size: 13px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .work-play { color: #d4af37; font-size: 20px; padding: 10px; }
    
    /* Gallery Folder & Grid */
    #gallery-screen { display: none; background: #000; }
    #folder-content-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 3000; flex-direction: column; }
    .gallery-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; padding: 5px; }
    .gallery-img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 4px; }
    
    #image-viewer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; align-items: center; justify-content: center; }
    #full-img { max-width: 100%; max-height: 100%; object-fit: contain; }

    /* UI Components */
    .fab { position: fixed; bottom: 90px; right: 30px; width: 60px; height: 60px; background: #d4af37; border-radius: 50%; color: #000; font-size: 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(212,175,55,0.4); z-index: 1000; }
    .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 60px; background: #111; display: flex; border-top: 1px solid #333; z-index: 1500; }
    .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; font-size: 10px; }
    .nav-item.active { color: #d4af37; }
    .nav-icon { font-size: 20px; margin-bottom: 4px; }
    
    /* Modals */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 4000; align-items: center; justify-content: center; }
    .modal-content { background: #222; padding: 20px; border-radius: 10px; width: 80%; border: 1px solid #d4af37; }
    input, textarea { width: 100%; padding: 10px; margin: 10px 0; background: #000; border: 1px solid #555; color: #fff; box-sizing: border-box; }
    .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
    .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
    .btn-save { background: #d4af37; color: #000; }
    .btn-cancel { background: #555; color: #fff; }
</style>
</head>
<body>

<div id="calculator-screen">
    <div class="calc-display">0</div>
    <div class="calc-buttons">
        <button class="calc-btn grey" onclick="calc('AC')">AC</button>
        <button class="calc-btn grey">+/-</button>
        <button class="calc-btn grey">%</button>
        <button class="calc-btn orange">√∑</button>
        <button class="calc-btn" onclick="calc('7')">7</button>
        <button class="calc-btn" onclick="calc('8')">8</button>
        <button class="calc-btn" onclick="calc('9')">9</button>
        <button class="calc-btn orange">√ó</button>
        <button class="calc-btn" onclick="calc('4')">4</button>
        <button class="calc-btn" onclick="calc('5')">5</button>
        <button class="calc-btn" onclick="calc('6')">6</button>
        <button class="calc-btn orange">‚àí</button>
        <button class="calc-btn" onclick="calc('1')">1</button>
        <button class="calc-btn" onclick="calc('2')">2</button>
        <button class="calc-btn" onclick="calc('3')">3</button>
        <button class="calc-btn orange">+</button>
        <button class="calc-btn zero" onclick="calc('0')">0</button>
        <button class="calc-btn">.</button>
        <button class="calc-btn orange" onclick="calc('=')">=</button>
    </div>
</div>

<div id="app-container">
    <div class="app-header">
        <div class="header-btn left" onclick="exportData()">‚öô</div>
        <div class="header-center"><h1>MUSEUM</h1></div>
        <div class="header-btn right" onclick="randomPick()">üîÄ</div>
    </div>

    <div id="home-screen" class="tab-content" style="display:block;">
        <div class="section-title">ÁôªÈå≤Ê∏à„Åø„ÅÆ„Éü„É•„Éº„Ç∫</div>
        <div id="person-list" class="card-list"></div>
        <div class="fab" onclick="openModal('person-modal')">Ôºã</div>
    </div>

    <div id="gallery-screen" class="tab-content">
        <div class="section-title">„Éï„Ç©„É´„ÉÄ‰∏ÄË¶ß</div>
        <div id="folder-list" class="card-list"></div>
        <div class="fab" onclick="openModal('folder-modal')">Ôºã</div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('home')">
            <div class="nav-icon">üèõÔ∏è</div><div>MUSEUM</div>
        </div>
        <div class="nav-item" onclick="switchTab('gallery')">
            <div class="nav-icon">üñºÔ∏è</div><div>GALLERY</div>
        </div>
    </div>
</div>

<div id="detail-screen">
    <div class="back-btn" onclick="closeDetail()">‚Üê</div>
    <div class="detail-header"><img id="d-img"></div>
    <div class="detail-info">
        <div class="detail-name" id="d-name"></div>
        <div class="detail-meta" id="d-meta"></div>
        <div class="person-profile-text" id="d-profile" style="font-size:12px; color:#ccc; margin-bottom:20px; white-space:pre-wrap;"></div>
        <div class="section-title">COLLECTION</div>
        <div id="d-work-list" class="work-list"></div>
    </div>
    <div class="fab" onclick="openModal('work-modal')">Ôºã</div>
</div>

<div id="folder-content-screen">
    <div class="app-header">
        <div class="header-btn left" onclick="closeFolder()">‚Üê</div>
        <div class="header-center"><h1 id="folder-title">Folder</h1></div>
        <div class="header-btn right" onclick="toggleSelectMode()">‚òë</div>
    </div>
    <div id="folder-grid" class="gallery-grid" style="overflow-y:auto; padding-top:60px; padding-bottom:80px;"></div>
    <div class="fab" id="gallery-fab" onclick="document.getElementById('img-input').click()">Ôºã</div>
    <div class="fab" id="delete-fab" style="display:none; background:#a00;" onclick="deleteSelected()">üóëÔ∏è</div>
    <input type="file" id="img-input" multiple accept="image/*" style="display:none;" onchange="addImages(this)">
</div>

<div id="image-viewer" onclick="this.style.display='none'">
    <img id="full-img">
</div>

<div id="person-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">Add Muse</div>
        <input type="text" id="p-name" placeholder="Name">
        <input type="text" id="p-cup" placeholder="Cup">
        <input type="date" id="p-birth">
        <textarea id="p-prof" placeholder="Profile"></textarea>
        <label class="file-select-btn">Image <input type="file" id="p-img" style="display:none;" onchange="preview(this,'p-prev')"></label>
        <img id="p-prev" style="width:100px; display:block; margin:10px auto;">
        <label><input type="checkbox" id="p-hof"> Hall of Fame</label>
        <div class="btn-group">
            <button class="btn btn-cancel" onclick="closeModal('person-modal')">Cancel</button>
            <button class="btn btn-save" onclick="savePerson()">Save</button>
        </div>
    </div>
</div>

<div id="work-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">Add Work</div>
        <input type="text" id="w-title" placeholder="Title">
        <div class="btn-group">
            <button class="btn btn-cancel" onclick="closeModal('work-modal')">Cancel</button>
            <button class="btn btn-save" onclick="saveWork()">Save</button>
        </div>
    </div>
</div>

<div id="folder-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">New Folder</div>
        <input type="text" id="f-name" placeholder="Folder Name">
        <label class="file-select-btn">Cover <input type="file" id="f-img" style="display:none;" onchange="preview(this,'f-prev')"></label>
        <img id="f-prev" style="width:100px; display:block; margin:10px auto;">
        <div class="btn-group">
            <button class="btn btn-cancel" onclick="closeModal('folder-modal')">Cancel</button>
            <button class="btn btn-save" onclick="saveFolder()">Create</button>
        </div>
    </div>
</div>

<script>
    // --- 1. CALCULATOR (Simple & Robust) ---
    let calcIn = '0';
    function calc(v) {
        if(v === 'AC') calcIn = '0';
        else if(v === '=') {
            if(calcIn === '4519') startApp();
            else calcIn = '0';
        } else {
            if(calcIn === '0') calcIn = v; else calcIn += v;
        }
        document.querySelector('.calc-display').innerText = calcIn;
    }
    
    function startApp() {
        document.getElementById('calculator-screen').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        loadPeople();
    }

    // --- 2. DATABASE (Ver 1000 - Reset) ---
    let db;
    const req = indexedDB.open("SecretMuseumV4", 1000);
    req.onupgradeneeded = e => {
        db = e.target.result;
        if(!db.objectStoreNames.contains('people')) db.createObjectStore('people', {keyPath:'id', autoIncrement:true});
        if(!db.objectStoreNames.contains('works')) {
            const ws = db.createObjectStore('works', {keyPath:'id', autoIncrement:true});
            ws.createIndex('personId', 'personId', {unique:false});
        }
        if(!db.objectStoreNames.contains('folders')) db.createObjectStore('folders', {keyPath:'id', autoIncrement:true});
        if(!db.objectStoreNames.contains('images')) {
            const is = db.createObjectStore('images', {keyPath:'id', autoIncrement:true});
            is.createIndex('folderId', 'folderId', {unique:false});
        }
    };
    req.onsuccess = e => { db = e.target.result; };

    // --- 3. CORE FUNCTIONS (Ver 17.0 Logic) ---
    let currentPersonId = null;

    function loadPeople() {
        if(!db) { setTimeout(loadPeople, 100); return; }
        const tx = db.transaction('people', 'readonly');
        const store = tx.objectStore('people');
        const list = document.getElementById('person-list');
        list.innerHTML = '';
        store.getAll().onsuccess = e => {
            e.target.result.forEach(p => {
                const card = document.createElement('div');
                card.className = 'person-card' + (p.hof ? ' hof' : '');
                const img = p.image ? `<img src="${p.image}">` : '<div style="color:#555;font-size:10px;">NO IMG</div>';
                card.innerHTML = `<div class="thumb-area">${img}</div><div class="info-area"><div class="name">${p.name}</div><div class="count">${p.count||0} Âõû</div></div>`;
                card.onclick = () => showDetail(p.id);
                list.appendChild(card);
            });
        };
    }

    function showDetail(id) {
        currentPersonId = id;
        document.getElementById('home-screen').style.display = 'none';
        document.getElementById('detail-screen').style.display = 'flex';
        
        const tx = db.transaction(['people', 'works'], 'readonly');
        tx.objectStore('people').get(id).onsuccess = e => {
            const p = e.target.result;
            document.getElementById('d-name').innerText = p.name;
            document.getElementById('d-meta').innerText = `${p.cup || '-'}„Ç´„ÉÉ„Éó / ${getAge(p.birth)}Ê≠≥`;
            document.getElementById('d-profile').innerText = p.profile || '';
            document.getElementById('d-img').src = p.image || '';
        };
        
        const wList = document.getElementById('d-work-list');
        wList.innerHTML = '';
        tx.objectStore('works').index('personId').getAll(id).onsuccess = e => {
            e.target.result.forEach(w => {
                const div = document.createElement('div');
                div.className = 'work-item';
                div.innerHTML = `<div class="work-title">${w.title}</div><div class="work-play" onclick="playWork(${w.id})">‚ñ∂</div>`;
                wList.appendChild(div);
            });
        };
    }

    function closeDetail() {
        document.getElementById('detail-screen').style.display = 'none';
        document.getElementById('home-screen').style.display = 'block';
        loadPeople();
    }

    function playWork(wid) {
        const tx = db.transaction(['people', 'works'], 'readwrite');
        tx.objectStore('works').get(wid).onsuccess = e => {
            const w = e.target.result;
            w.count = (w.count || 0) + 1;
            tx.objectStore('works').put(w);
        };
        tx.objectStore('people').get(currentPersonId).onsuccess = e => {
            const p = e.target.result;
            p.count = (p.count || 0) + 1;
            tx.objectStore('people').put(p);
        };
        tx.oncomplete = () => {
            showDetail(currentPersonId); // Reload
            alert("Recorded!");
        }
    }

    // --- 4. GALLERY (Independent) ---
    let currentFolderId = null;
    let selectMode = false;
    let selectedImgs = new Set();

    function loadFolders() {
        const list = document.getElementById('folder-list');
        list.innerHTML = '';
        db.transaction('folders', 'readonly').objectStore('folders').getAll().onsuccess = e => {
            e.target.result.forEach(f => {
                const div = document.createElement('div');
                div.className = 'folder-card';
                const img = f.image ? `<img src="${f.image}">` : 'üìÅ';
                div.innerHTML = `<div class="thumb-area">${img}</div><div class="info-area"><div class="name">${f.name}</div><div class="card-menu" onclick="event.stopPropagation();deleteFolder(${f.id})">‚ãÆ</div></div>`;
                div.onclick = () => openFolder(f.id, f.name);
                list.appendChild(div);
            });
        };
    }

    function openFolder(id, name) {
        currentFolderId = id;
        document.getElementById('gallery-screen').style.display = 'none';
        document.getElementById('folder-content-screen').style.display = 'flex';
        document.getElementById('folder-title').innerText = name;
        loadImages();
    }

    function closeFolder() {
        document.getElementById('folder-content-screen').style.display = 'none';
        document.getElementById('gallery-screen').style.display = 'block';
        loadFolders();
    }

    function loadImages() {
        const grid = document.getElementById('folder-grid');
        grid.innerHTML = '';
        db.transaction('images', 'readonly').objectStore('images').index('folderId').getAll(currentFolderId).onsuccess = e => {
            e.target.result.forEach((img, idx) => {
                const el = document.createElement('div');
                el.className = 'gallery-item';
                const chk = selectMode && selectedImgs.has(img.id) ? ' selected' : '';
                el.innerHTML = `<img src="${img.data}" class="gallery-thumb"><div class="gallery-check">‚úì</div>`;
                if(chk) el.classList.add('selected');
                el.onclick = () => {
                    if(selectMode) {
                        if(selectedImgs.has(img.id)) { selectedImgs.delete(img.id); el.classList.remove('selected'); }
                        else { selectedImgs.add(img.id); el.classList.add('selected'); }
                    } else {
                        document.getElementById('image-viewer').style.display = 'flex';
                        document.getElementById('full-img').src = img.data;
                    }
                };
                grid.appendChild(el);
            });
        };
    }

    function addImages(input) {
        const files = Array.from(input.files);
        if(!files.length) return;
        const tx = db.transaction('images', 'readwrite');
        const store = tx.objectStore('images');
        let count = 0;
        files.forEach(f => {
            const r = new FileReader();
            r.onload = e => {
                store.add({ folderId: currentFolderId, data: e.target.result });
                count++;
                if(count === files.length) {
                    setTimeout(loadImages, 500);
                }
            };
            r.readAsDataURL(f);
        });
    }

    function toggleSelectMode() {
        selectMode = !selectMode;
        selectedImgs.clear();
        document.getElementById('gallery-fab').style.display = selectMode ? 'none' : 'flex';
        document.getElementById('delete-fab').style.display = selectMode ? 'flex' : 'none';
        loadImages();
    }

    function deleteSelected() {
        if(!confirm("Delete?")) return;
        const tx = db.transaction('images', 'readwrite');
        selectedImgs.forEach(id => tx.objectStore('images').delete(id));
        tx.oncomplete = () => {
            selectMode = false;
            toggleSelectMode(); // Reset UI
        };
    }

    function deleteFolder(id) {
        if(confirm("Delete Folder?")) {
            const tx = db.transaction(['folders', 'images'], 'readwrite');
            tx.objectStore('folders').delete(id);
            // Simple delete, images might remain orphaned but UI is clean
            tx.oncomplete = loadFolders;
        }
    }

    // === UTILS ===
    function switchTab(t) {
        document.getElementById('home-screen').style.display = 'none';
        document.getElementById('gallery-screen').style.display = 'none';
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(t === 'home') {
            document.getElementById('home-screen').style.display = 'block';
            loadPeople();
        } else {
            document.getElementById('gallery-screen').style.display = 'block';
            loadFolders();
        }
    }
    
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    function preview(inpt, imgId) {
        const r = new FileReader();
        r.onload = e => document.getElementById(imgId).src = e.target.result;
        if(inpt.files[0]) r.readAsDataURL(inpt.files[0]);
    }

    function savePerson() {
        const n = document.getElementById('p-name').value;
        if(!n) return;
        const tx = db.transaction('people', 'readwrite');
        const d = {
            name: n,
            cup: document.getElementById('p-cup').value,
            birth: document.getElementById('p-birth').value,
            profile: document.getElementById('p-prof').value,
            hof: document.getElementById('p-hof').checked,
            count: 0
        };
        const img = document.getElementById('p-prev').src;
        if(img) d.image = img;
        tx.objectStore('people').add(d);
        tx.oncomplete = () => { closeModal('person-modal'); loadPeople(); };
    }

    function saveWork() {
        const t = document.getElementById('w-title').value;
        if(!t) return;
        db.transaction('works', 'readwrite').objectStore('works').add({
            personId: currentPersonId,
            title: t,
            count: 0
        }).onsuccess = () => {
            closeModal('work-modal');
            showDetail(currentPersonId);
        };
    }

    function saveFolder() {
        const n = document.getElementById('f-name').value;
        if(!n) return;
        const d = { name: n };
        const img = document.getElementById('f-prev').src;
        if(img) d.image = img;
        db.transaction('folders', 'readwrite').objectStore('folders').add(d).onsuccess = () => {
            closeModal('folder-modal');
            loadFolders();
        };
    }

    function getAge(b) {
        if(!b) return '';
        const d = new Date(b); const n = new Date();
        let a = n.getFullYear() - d.getFullYear();
        return a;
    }
    
    function randomPick() {
         db.transaction('people').objectStore('people').getAll().onsuccess = e => {
             const r = e.target.result;
             if(r.length) showDetail(r[Math.floor(Math.random() * r.length)].id);
         };
    }
    
    function exportData() {
        const d = {};
        const tx = db.transaction(['people', 'works', 'folders', 'images'], 'readonly');
        tx.objectStore('people').getAll().onsuccess = e => d.people = e.target.result;
        tx.objectStore('works').getAll().onsuccess = e => d.works = e.target.result;
        tx.objectStore('folders').getAll().onsuccess = e => d.folders = e.target.result;
        tx.objectStore('images').getAll().onsuccess = e => d.images = e.target.result;
        tx.oncomplete = () => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(d)], {type:'application/json'}));
            a.download = 'backup.json';
            a.click();
        };
    }
</script>
</body>
</html>
