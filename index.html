<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Clock</title>
<style>
    /* === ÂÖ±ÈÄöË®≠ÂÆö === */
    body { margin: 0; padding: 0; font-family: "Helvetica Neue", Arial, sans-serif; background-color: #000; color: #fff; overflow: hidden; height: 100vh; width: 100vw; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
    .fade-in { animation: fadeIn 0.5s ease forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spinSlow { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }

    /* === 1. „ÉÄ„Éü„ÉºÁîªÈù¢ („Éü„Éã„Éû„É´„Éª„ÇØ„É≠„ÉÉ„ÇØ) === */
    #dummy-screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #000;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        z-index: 9999; transition: opacity 0.6s ease;
    }
    
    .clock-container { text-align: center; cursor: pointer; }
    .clock-time { font-size: 80px; font-weight: 200; letter-spacing: -2px; color: #f0f0f0; margin-bottom: 10px; }
    .clock-date { font-size: 18px; color: #666; letter-spacing: 2px; text-transform: uppercase; }
    
    /* Èö†„ÅóÂÖ•Âäõ„Éï„Ç©„Éº„É† */
    .passcode-wrapper {
        margin-top: 30px; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        display: flex; gap: 10px; flex-direction: column; align-items: center;
    }
    .passcode-wrapper.visible { opacity: 1; pointer-events: auto; }
    .passcode-input {
        background: transparent; border: none; border-bottom: 2px solid #333;
        color: #fff; font-size: 24px; text-align: center; width: 120px;
        outline: none; letter-spacing: 5px;
    }
    .passcode-input::placeholder { color: #333; letter-spacing: 0; font-size: 14px; }
    .unlock-btn {
        padding: 8px 20px; border: 1px solid #333; background: transparent; color: #666;
        border-radius: 20px; font-size: 12px; cursor: pointer; margin-top: 10px;
    }

    /* === „Ç¢„Éó„É™„Ç≥„É≥„ÉÜ„Éä === */
    #app-container { display: none; height: 100%; width: 100%; font-family: "YuMincho", "Hiragino Mincho ProN", serif; }

    /* === „Éò„ÉÉ„ÉÄ„Éº & „Éä„Éì === */
    .app-header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .header-center { text-align: center; width: 60%; }
    .app-header h1 { font-family: "Times New Roman", serif; font-size: 18px; color: #d4af37; letter-spacing: 0.1em; margin: 0; }
    .app-header .subtitle { font-family: "Times New Roman", serif; font-size: 8px; color: #888; letter-spacing: 0.2em; text-transform: uppercase; }
    .header-btn { position: absolute; top: 0; height: 60px; width: 60px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #d4af37; cursor: pointer; z-index: 1100; }
    .header-btn.left { left: 0; }
    .header-btn.right { right: 0; }

    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: #000; border-top: 1px solid #333; display: flex; justify-content: space-around; align-items: center; padding-bottom: constant(safe-area-inset-bottom); padding-bottom: env(safe-area-inset-bottom); z-index: 1500; }
    .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 10px; transition: color 0.3s; }
    .nav-item.active { color: #d4af37; }
    .nav-icon { font-size: 20px; margin-bottom: 4px; }

    /* === „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ === */
    .tab-content { display: none; height: 100%; width: 100%; box-sizing: border-box; padding-top: 60px; padding-bottom: 80px; overflow-y: auto; flex-direction: column; }
    
    /* Home Utils */
    .mode-switch-container { display: flex; justify-content: center; padding: 15px 0; gap: 20px; }
    .mode-btn { font-size: 12px; color: #666; border-bottom: 2px solid transparent; padding-bottom: 5px; cursor: pointer; transition: 0.3s; letter-spacing: 0.1em; }
    .mode-btn.active { color: #d4af37; border-bottom: 2px solid #d4af37; font-weight: bold; }

    .search-area-wrapper { padding: 0 20px 10px; display: flex; gap: 10px; align-items: center; }
    .search-input { flex-grow: 1; padding: 10px; border-radius: 8px; border: 1px solid #333; background: rgba(255,255,255,0.1); color: #fff; font-size: 14px; outline: none; }
    .filter-btn { width: 40px; height: 38px; border-radius: 8px; border: 1px solid #333; background: rgba(255,255,255,0.1); color: #d4af37; font-size: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .filter-btn.active { background: #d4af37; color: #000; }
    .sort-btn { width: 40px; height: 38px; border-radius: 8px; border: 1px solid #333; background: rgba(255,255,255,0.1); color: #ccc; font-size: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

    .section-title { color: #888; font-size: 11px; margin: 20px 20px 10px; letter-spacing: 0.1em; font-family: "Times New Roman", serif; }

    /* Lists & Cards */
    .card-list { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 0 20px; padding-bottom: 120px; }
    
    .card { background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 8px; overflow: hidden; position: relative; transition: transform 0.1s; }
    .card:active { transform: scale(0.96); border-color: #d4af37; }
    .card.pressing { transform: scale(0.95); border-color: #ff4444; }
    .card.hof { border-color: #d4af37; box-shadow: 0 0 10px rgba(212, 175, 55, 0.2); }
    
    /* Person Card Style */
    .person-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(212, 175, 55, 0.2); border-radius: 8px; overflow: hidden; backdrop-filter: blur(10px); position: relative; transition: transform 0.1s; }
    .person-card:active { transform: scale(0.96); border-color: #d4af37; }
    .person-card.pressing { transform: scale(0.95); border-color: #ff4444; }
    .person-card.hof { border: 2px solid #d4af37; box-shadow: 0 0 15px rgba(212, 175, 55, 0.4); }

    .thumb-area { height: 140px; background-color: #050505; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
    .thumb-area img { width: 100%; height: 100%; object-fit: cover; }
    .thumb-placeholder { color: #333; font-size: 10px; }
    
    .info-area { padding: 10px; }
    .name { color: #f0f0f0; font-size: 15px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
    .count { color: #d4af37; font-size: 11px; }

    /* Work Card Style */
    .work-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(212, 175, 55, 0.2); border-radius: 8px; overflow: hidden; backdrop-filter: blur(10px); position: relative; transition: transform 0.1s; }
    .work-card:active { transform: scale(0.96); border-color: #d4af37; }
    .work-card.hof { border: 2px solid #d4af37; box-shadow: 0 0 15px rgba(212, 175, 55, 0.4); }
    .work-card-title { color: #f0f0f0; font-size: 14px; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; height: 2.8em; }
    
    .card-crown { position: absolute; top: 5px; right: 5px; font-size: 16px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); z-index: 5; }
    .rating-stars-sm { font-size: 10px; color: #888; margin-top: 2px; }
    .rating-stars-sm .on { color: #d4af37; }

    /* Analysis Elements */
    .stats-area { margin: 0 20px 20px; padding: 15px; background: linear-gradient(135deg, rgba(212,175,55,0.1), transparent); border-left: 2px solid #d4af37; border-radius: 0 8px 8px 0; }
    .stats-value { font-size: 24px; color: #fff; }
    
    .calendar-container { margin: 0 20px 30px; background: #111; padding: 15px; border-radius: 8px; border: 1px solid #333; }
    .cal-header { display: flex; justify-content: space-between; margin-bottom: 10px; color: #d4af37; font-family: serif; }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
    .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #444; border-radius: 2px; }
    .cal-day.active { background: rgba(212, 175, 55, 0.3); color: #fff; border: 1px solid rgba(212,175,55,0.5); }
    .cal-day.today { border: 1px solid #666; }

    .tag-bar { display: flex; align-items: center; margin-bottom: 6px; padding: 0 20px; }
    .tag-label { width: 70px; font-size: 11px; color: #ccc; text-align: right; padding-right: 10px; }
    .tag-track { flex-grow: 1; background: #222; height: 4px; border-radius: 2px; }
    .tag-fill { height: 100%; background: #d4af37; border-radius: 2px; }
    .tag-val { width: 25px; font-size: 10px; color: #888; margin-left: 8px; }

    .pie-chart-container { display: flex; justify-content: center; margin-bottom: 20px; position: relative; height: 160px; }
    .pie-chart { width: 150px; height: 150px; border-radius: 50%; background: conic-gradient(#d4af37 0% 0%); position: relative; }
    .pie-hole { position: absolute; width: 80px; height: 80px; background: #050505; border-radius: 50%; top: 35px; left: 35px; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    .pie-legend { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; font-size: 10px; color: #ccc; margin-bottom: 30px; }
    .legend-item { display: flex; align-items: center; gap: 4px; }
    .legend-color { width: 8px; height: 8px; border-radius: 2px; }

    /* The QUEEN */
    .champion-area { margin: 0 20px 30px; display: none; }
    .champion-box { position: relative; background-color: #050505; border: 1px solid #d4af37; border-radius: 12px; padding: 40px 20px 20px; text-align: center; overflow: hidden; box-shadow: inset 0 0 50px rgba(0,0,0,0.9), 0 0 15px rgba(212, 175, 55, 0.2); }
    .champion-title { font-family: "Times New Roman", serif; color: #d4af37; font-size: 12px; letter-spacing: 0.3em; margin-bottom: 30px; text-transform: uppercase; display: inline-block; border-bottom: 1px solid rgba(212,175,55,0.3); padding-bottom: 5px; position: relative; z-index: 2; }
    .champion-img-container { position: relative; width: 110px; height: 110px; margin: 0 auto 15px; }
    /* Big Golden Flower */
    .champion-bg-flower { position: absolute; top: 50%; left: 50%; width: 240px; height: 240px; background: repeating-conic-gradient(from 0deg, rgba(212, 175, 55, 0.2) 0deg 15deg, transparent 15deg 30deg); border-radius: 50%; transform: translate(-50%, -50%); z-index: 0; animation: spinSlow 30s linear infinite; pointer-events: none; }
    .champion-bg-flower::before { content: ""; position: absolute; inset: 20px; border-radius: 50%; background: radial-gradient(circle, rgba(212, 175, 55, 0.3) 0%, transparent 60%); }
    .champion-img { position: relative; z-index: 1; width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid #fff; box-shadow: 0 0 20px rgba(212, 175, 55, 0.6); }
    .champion-crown { position: absolute; top: -50px; left: 50%; transform: translateX(-50%); font-size: 40px; z-index: 5; text-shadow: 0 5px 10px rgba(0,0,0,0.8); filter: drop-shadow(0 0 5px #d4af37); }
    .champion-name { font-size: 24px; font-weight: bold; margin-bottom: 5px; color: #fff; font-family: serif; text-shadow: 0 2px 10px rgba(0,0,0,0.8); position: relative; z-index: 2; }
    .champion-score { color: #aaa; font-size: 14px; font-family: monospace; position: relative; z-index: 2; }

    /* Gobusata */
    .gobusata-scroller { display: flex; gap: 10px; overflow-x: auto; padding: 0 20px 10px; }
    .gobusata-item { min-width: 70px; text-align: center; }
    .gobusata-img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; filter: grayscale(100%); opacity: 0.6; border: 1px solid #444; }
    .gobusata-name { font-size: 9px; color: #888; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Detail Screen */
    #detail-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2500; flex-direction: column; }
    .detail-fixed-header { flex-shrink: 0; position: relative; width: 100%; height: 45vh; overflow: hidden; border-bottom: 1px solid rgba(212, 175, 55, 0.3); }
    .detail-bg-img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
    .detail-overlay { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, #000 10%, transparent); padding: 20px; box-sizing: border-box; }
    .detail-name { font-size: 32px; font-weight: bold; margin-bottom: 2px; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }
    .detail-specs { font-size: 13px; color: #fff; margin-bottom: 5px; font-family: sans-serif; display: flex; gap: 10px; align-items: center; }
    .detail-spec-item { background: rgba(212, 175, 55, 0.2); padding: 2px 8px; border-radius: 4px; border: 1px solid rgba(212, 175, 55, 0.4); }
    .detail-stats { color: #d4af37; font-family: monospace; font-size: 14px; margin-bottom: 8px;}
    .person-profile-text { font-size: 12px; color: #ccc; line-height: 1.5; margin-bottom: 10px; }
    .person-tags-area { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px; }
    .back-btn { position: absolute; top: 50px; left: 20px; z-index: 2600; width: 40px; height: 40px; background: rgba(0,0,0,0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #d4af37; font-size: 24px; cursor: pointer; border: 1px solid rgba(212,175,55,0.3); }
    .detail-sticky-bar { flex-shrink: 0; background: #000; padding: 15px 20px; border-bottom: 1px solid #222; display:flex; justify-content:space-between; align-items:center; z-index: 10; }
    .detail-scroll-area { flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; -webkit-overflow-scrolling: touch; }
    
    .work-item { background: rgba(30,30,30,0.6); border-left: 3px solid #d4af37; padding: 15px; margin-bottom: 15px; border-radius: 0 6px 6px 0; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; position: relative; }
    .work-item.pressing { background: rgba(100, 30, 30, 0.6); }
    .work-item.hof { border-color: #d4af37; box-shadow: 0 0 10px rgba(212, 175, 55, 0.1); background: rgba(40,35,20,0.6); }
    .work-thumb { width: 50px; height: 50px; object-fit: cover; margin-right: 10px; border-radius: 4px; border: 1px solid #444; flex-shrink: 0; }
    .work-info { flex-grow: 1; min-width: 0; padding-right: 10px; }
    .work-info h3 { margin: 0 0 5px 0; font-size: 16px; font-weight: normal; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: 5px; }
    .work-tags { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 5px; }
    .tag { font-size: 10px; background: #333; color: #aaa; padding: 2px 6px; border-radius: 4px; }
    .work-count { font-size: 11px; color: #888; font-family: monospace; display: flex; align-items: center; gap: 4px; }
    .link-btn { width: 36px; height: 36px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #ccc; font-size: 16px; margin-right: 10px; flex-shrink: 0; border: 1px solid #555; }
    .play-btn { width: 40px; height: 40px; background: #d4af37; color:#000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 0 10px rgba(212,175,55,0.3); flex-shrink: 0; }
    .play-btn:active { transform: scale(0.9); background: #fff; }

    /* Work Detail */
    #work-detail-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 3000; flex-direction: column; overflow-y: auto; }
    .wd-image-area { width: 100%; height: 45vh; overflow: hidden; display:flex; align-items:center; justify-content:center; background:#111; flex-shrink: 0; }
    .wd-image { width: 100%; height: 100%; object-fit: cover; }
    .wd-info { padding: 20px; }
    .wd-title { font-size: 20px; color: #d4af37; margin-bottom: 15px; line-height: 1.4; font-family: serif; }
    .wd-meta { font-size: 12px; color: #888; margin-bottom: 20px; border-left: 2px solid #555; padding-left: 10px; }
    .wd-tags { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 30px; }
    .wd-actions { display: flex; gap: 15px; justify-content: center; }
    .wd-btn { flex: 1; padding: 15px; border-radius: 8px; text-align: center; font-size: 14px; font-weight: bold; cursor: pointer; }
    .wd-play { background: #d4af37; color: #000; }
    .wd-link { background: #333; color: #fff; border: 1px solid #555; }

    /* Modals */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); z-index: 4000; align-items: center; justify-content: center; }
    .modal-content { background: #151515; border: 1px solid #d4af37; padding: 20px; width: 85%; max-height: 85vh; overflow-y: auto; border-radius: 10px; text-align: center; }
    .modal-title { color: #d4af37; margin-bottom: 20px; font-size: 16px; font-family: serif; letter-spacing: 1px; }
    input, textarea { width: 100%; padding: 10px; margin-bottom: 10px; background: #222; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; }
    .file-btn { display: block; padding: 10px; background: #222; border: 1px dashed #666; color: #888; border-radius: 4px; margin-bottom: 10px; font-size: 12px; }
    .preview-box { height: 150px; background: #000; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; border: 1px solid #333; }
    .preview-box img { width: 100%; height: 100%; object-fit: contain; }
    .focus-point { position: absolute; width: 20px; height: 20px; border: 2px solid #d4af37; border-radius: 50%; background: rgba(212,175,55,0.3); transform: translate(-50%, -50%); pointer-events: none; display: none; }
    .btn-row { display: flex; gap: 10px; margin-top: 10px; }
    .btn { flex: 1; padding: 10px; border-radius: 4px; border: none; font-family: serif; cursor: pointer; }
    .btn-save { background: #d4af37; color: #000; font-weight: bold; }
    .btn-cancel { background: #333; color: #ccc; }
    .btn-del { background: #500; color: #fff; font-size: 10px; margin-top: 20px; width: 100%; }

    /* Tag Filter Chips */
    .tag-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; justify-content: center; }
    .filter-chip { padding: 6px 12px; border-radius: 20px; border: 1px solid #555; font-size: 12px; color: #aaa; cursor: pointer; transition: 0.2s; }
    .filter-chip.selected { background: #d4af37; color: #000; border-color: #d4af37; }
    .filter-options { text-align: left; margin-top: 15px; border-top: 1px solid #333; padding-top: 15px; }
    .checkbox-label { display: flex; align-items: center; justify-content: center; font-size: 12px; color: #ccc; cursor: pointer; }
    .checkbox-label input { width: auto; margin: 0 8px 0 0; }
    .tag-suggestions { display: flex; flex-wrap: wrap; gap: 5px; margin-top: -10px; margin-bottom: 15px; }
    .tag-s-chip { font-size: 10px; background: #333; border: 1px solid #555; padding: 3px 8px; border-radius: 10px; color: #ccc; cursor: pointer; transition:0.2s;}
    .tag-s-chip:active { background: #d4af37; color: #000; }

    /* Rating/HOF */
    .star-rating { display: flex; justify-content: center; gap: 5px; margin-bottom: 15px; font-size: 24px; color: #444; cursor: pointer; }
    .star-rating span.on { color: #d4af37; }
    .hof-toggle { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 10px 0; font-size: 12px; color: #ccc; cursor: pointer; }
    .crown-icon { font-size: 16px; filter: grayscale(100%); }
    .crown-icon.active { filter: grayscale(0%); text-shadow: 0 0 5px gold; }

    /* Sort Menu */
    .sort-menu { display: none; position: absolute; top: 50px; right: 20px; background: #222; border: 1px solid #555; border-radius: 6px; z-index: 2000; }
    .sort-item { padding: 10px 20px; font-size: 12px; border-bottom: 1px solid #333; }
    .sort-item:last-child { border: none; }
    .sort-item:active { background: #444; }

</style>
</head>
<body>

<div id="toast">RECORDED<br><span style="font-size:10px; color:#fff;">Ë≥¢ËÄÖ„Çø„Ç§„É†„Å´ÂÖ•„Çä„Åæ„Åô</span></div>

<div id="dummy-screen" onclick="showUnlockInput()">
    <div class="clock-container">
        <div class="clock-time" id="dummy-time">00:00</div>
        <div class="clock-date" id="dummy-date">JAN 01 MON</div>
    </div>
    <div class="passcode-wrapper" id="pass-wrap">
        <input type="tel" class="passcode-input" id="pass-input" maxlength="4" placeholder="----">
        <button class="unlock-btn" onclick="checkCode()">UNLOCK</button>
    </div>
</div>

<div id="app-container">
    <header class="app-header">
        <div class="header-btn left" onclick="openSettings()">‚öô</div>
        <div class="header-center" id="panic-btn">
            <div class="subtitle">PRIVATE COLLECTION</div>
            <h1>MUSEUM</h1>
        </div>
        <div class="header-btn right" onclick="randomPick()">üîÄ</div>
    </header>

    <div id="home-screen" class="tab-content">
        <div class="mode-switch-container">
            <div class="mode-btn active" id="btn-mode-people" onclick="switchHomeMode('people')">MUSE</div>
            <div class="mode-btn" id="btn-mode-works" onclick="switchHomeMode('works')">LIBRARY</div>
        </div>
        <div class="search-area-wrapper">
            <input type="search" class="search-input" id="search-input" placeholder="Search..." oninput="filterHome()">
            <div class="icon-btn" onclick="openTagFilter()">üè∑Ô∏è</div>
            <div class="icon-btn" onclick="toggleSort('home')">‚áÖ</div>
        </div>
        
        <div class="sort-menu" id="sort-menu-home">
            <div class="sort-item" onclick="setSort('count', 'home')">Count</div>
            <div class="sort-item" onclick="setSort('newest', 'home')">Newest</div>
            <div class="sort-item" onclick="setSort('rating', 'home')">Rating/HOF</div>
        </div>

        <div class="section-title" id="home-title">MUSE LIST</div>
        <div class="card-list" id="home-list"></div>
        <div class="fab" onclick="addPerson()">Ôºã</div>
    </div>

    <div id="analysis-screen" class="tab-content">
        <div class="stats-area">
            <div class="stats-title">TOTAL SELECTIONS</div>
            <div class="stats-value" id="total-count">0<span class="stats-unit">times</span></div>
        </div>
        <div class="section-title" style="margin-top:0;">ACTIVITY</div>
        <div class="calendar-container">
            <div class="cal-header"><div id="cal-label"></div></div>
            <div class="cal-grid" id="cal-grid"></div>
        </div>
        <div class="section-title">QUALITY</div>
        <div class="pie-chart-container" id="pie-rated"></div>
        
        <div class="section-title">TRENDS</div>
        <div id="person-tag-ranking" style="margin-bottom:20px;"></div>
        <div id="tag-ranking" style="margin-bottom:30px;"></div>

        <div class="champion-area" id="champion-area"></div>
        
        <div class="gobusata-area" id="gobusata-area">
            <div class="section-title">LONG TIME NO SEE</div>
            <div class="gobusata-scroller" id="gobusata-list"></div>
        </div>
        
        <div class="section-title">TOP RANKING</div>
        <div class="ranking-list" id="ranking-list"></div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="navTo('home')">
            <div class="nav-icon">üèõÔ∏è</div><div>MUSEUM</div>
        </div>
        <div class="nav-item" onclick="navTo('analysis')">
            <div class="nav-icon">üìä</div><div>ANALYSIS</div>
        </div>
    </nav>
</div>

<div id="detail-screen">
    <div class="back-btn" onclick="closeDetail()">‚Üê</div>
    <div class="detail-fixed-header">
        <img id="detail-bg" class="detail-bg-img">
        <div class="detail-overlay">
            <div class="detail-name" id="d-name">Name</div>
            <div class="detail-specs" id="d-specs"></div>
            <div class="detail-stats" id="d-stats">Selection: 0</div>
            <div class="person-profile-text" id="d-profile"></div>
            <div class="person-tags-area" id="d-tags"></div>
        </div>
    </div>
    <div class="detail-sticky-bar">
        <div class="section-title" style="margin:0;">WORKS</div>
        <div class="icon-btn" style="width:30px; height:30px;" onclick="toggleSort('detail')">‚áÖ</div>
    </div>
    <div class="sort-menu" id="sort-menu-detail" style="top:50vh; right:20px;">
        <div class="sort-item" onclick="setSort('count', 'detail')">Count</div>
        <div class="sort-item" onclick="setSort('newest', 'detail')">Newest</div>
        <div class="sort-item" onclick="setSort('rating', 'detail')">Rating</div>
    </div>

    <div class="detail-scroll-area">
        <div id="detail-work-list" style="padding: 0 20px 100px 20px;"></div>
    </div>
    <div class="fab" onclick="addWork()">Ôºã</div>
</div>

<div id="work-detail-screen">
    <div class="back-btn" onclick="closeWorkDetail()">‚Üì</div>
    <div class="wd-img-box">
        <img id="wd-img" class="wd-img">
        <div id="wd-no-img" style="color:#666; font-size:12px;">NO IMAGE</div>
    </div>
    <div class="wd-content">
        <div class="wd-title" id="wd-title">Title</div>
        <div class="wd-meta" id="wd-meta"></div>
        <div class="wd-tags" id="wd-tags" style="display:flex; gap:5px; flex-wrap:wrap; margin-top:10px;"></div>
        <div class="wd-btn-row">
            <div class="wd-btn wd-btn-link" id="wd-link" onclick="">LINK</div>
            <div class="wd-btn wd-btn-play" id="wd-play" onclick="">PLAY</div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-person">
    <div class="modal-content">
        <div class="modal-title">EDIT MUSE</div>
        <input type="hidden" id="p-id">
        <input type="text" id="p-name" placeholder="Name">
        <div style="display:flex; gap:10px;">
            <input type="text" id="p-cup" placeholder="Cup" style="flex:1;">
            <input type="date" id="p-bday" style="flex:2;">
        </div>
        <div class="hof-toggle" onclick="toggleHof('p-hof', 'p-hof-icon')">
            <span class="crown-icon" id="p-hof-icon">üëë</span> Hall of Fame
            <input type="checkbox" id="p-hof" style="display:none;">
        </div>
        <textarea id="p-profile" placeholder="Profile/Memo"></textarea>
        <input type="text" id="p-tags" placeholder="Tags (space separated)">
        <div class="tag-suggestions" id="p-tag-sugg"></div>
        
        <label class="file-btn">Choose Image <input type="file" onchange="previewFile(this, 'p-preview', 'p-focus')"></label>
        <div class="preview-box" onclick="setFocus(event, 'p-preview', 'p-focus')">
            <img id="p-preview" style="display:none;">
            <div id="p-focus" class="focus-point"></div>
            <div style="color:#666; font-size:10px;">Tap to set focus</div>
        </div>

        <div class="btn-row">
            <button class="btn btn-cancel" onclick="closeModal('modal-person')">CANCEL</button>
            <button class="btn btn-save" onclick="submitPerson()">SAVE</button>
        </div>
        <button class="btn btn-del" id="p-del-btn" onclick="deletePerson()">DELETE</button>
    </div>
</div>

<div class="modal-overlay" id="modal-work">
    <div class="modal-content">
        <div class="modal-title">EDIT WORK</div>
        <input type="hidden" id="w-id">
        <input type="text" id="w-title" placeholder="Title">
        <input type="url" id="w-url" placeholder="URL">
        
        <div class="star-rating" id="w-rating-ui">
            <span onclick="setRating(1)">‚òÖ</span><span onclick="setRating(2)">‚òÖ</span><span onclick="setRating(3)">‚òÖ</span><span onclick="setRating(4)">‚òÖ</span><span onclick="setRating(5)">‚òÖ</span>
        </div>
        
        <div class="hof-toggle" onclick="toggleHof('w-hof', 'w-hof-icon')">
            <span class="crown-icon" id="w-hof-icon">üëë</span> Hall of Fame
            <input type="checkbox" id="w-hof" style="display:none;">
        </div>
        
        <input type="text" id="w-tags" placeholder="Tags">
        <div class="tag-suggestions" id="w-tag-sugg"></div>
        
        <label class="file-btn">Choose Thumbnail <input type="file" onchange="previewFile(this, 'w-preview', 'w-focus')"></label>
        <div class="preview-box" onclick="setFocus(event, 'w-preview', 'w-focus')">
            <img id="w-preview" style="display:none;">
            <div id="w-focus" class="focus-point"></div>
        </div>

        <div class="btn-row">
            <button class="btn btn-cancel" onclick="closeModal('modal-work')">CANCEL</button>
            <button class="btn btn-save" onclick="submitWork()">SAVE</button>
        </div>
        <button class="btn btn-del" id="w-del-btn" onclick="deleteWork()">DELETE</button>
    </div>
</div>

<div class="modal-overlay" id="modal-filter">
    <div class="modal-content">
        <div class="modal-title">FILTER TAGS</div>
        <div class="tag-chips" id="filter-chips"></div>
        <div class="filter-options"><label class="checkbox-label"><input type="checkbox" id="filter-exact"> All tags must match (Exact)</label></div>
        <div class="btn-row">
            <button class="btn btn-cancel" onclick="clearFilter()">Clear</button>
            <button class="btn btn-save" onclick="applyFilter()">Apply</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-settings">
    <div class="modal-content">
        <div class="modal-title">SETTINGS</div>
        <button class="btn btn-save" style="margin-bottom:10px; width:100%;" onclick="exportData()">BACKUP</button>
        <label class="btn btn-cancel" style="display:block; margin-bottom:10px; width:100%; box-sizing:border-box;">
            RESTORE
            <input type="file" style="display:none;" onchange="restoreData(this)">
        </label>
        <button class="btn btn-cancel" style="width:100%;" onclick="closeModal('modal-settings')">CLOSE</button>
        <button class="btn btn-del" onclick="wipeData()">RESET ALL DATA</button>
    </div>
</div>

<script>
// ====================
// 1. CORE & CLOCK
// ====================
const CODE = '4519';
let db;
let currentPersonId = null;
let homeMode = 'people'; // 'people' or 'works'
let sortState = { home: 'count', detail: 'count' };
let focusTemp = { x:50, y:50 };
let inputBuffer = "";
let lastTapTime = 0;
let selectedTags = new Set();
let ratingTemp = 0;

// Clock Logic
function updateClock() {
    const now = new Date();
    const h = String(now.getHours()).padStart(2, '0');
    const m = String(now.getMinutes()).padStart(2, '0');
    document.getElementById('dummy-time').innerText = `${h}:${m}`;
    const dateOpts = { month: 'short', day: '2-digit', weekday: 'short' };
    document.getElementById('dummy-date').innerText = now.toLocaleDateString('en-US', dateOpts).toUpperCase();
}
setInterval(updateClock, 1000);
updateClock();

function showUnlockInput() {
    document.getElementById('pass-wrap').classList.add('visible');
    document.getElementById('pass-input').focus();
}

function checkCode() {
    const val = document.getElementById('pass-input').value;
    if(val === CODE) {
        if(navigator.vibrate) navigator.vibrate([50,50]);
        document.getElementById('dummy-screen').style.opacity = 0;
        setTimeout(() => {
            document.getElementById('dummy-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            loadHomeList(); // FORCE LOAD HERE
        }, 600);
    } else {
        if(navigator.vibrate) navigator.vibrate(200);
        document.getElementById('pass-input').value = "";
    }
}

// Panic
document.getElementById('panic-btn').addEventListener('click', (e) => {
    const now = new Date().getTime();
    if(now - lastTapTime < 300) location.reload();
    lastTapTime = now;
});

// DB Init
window.onload = () => {
    const req = indexedDB.open("SecretMuseumDB", 8);
    req.onupgradeneeded = (e) => {
        db = e.target.result;
        if(!db.objectStoreNames.contains("people")) db.createObjectStore("people", { keyPath:"id", autoIncrement:true });
        if(!db.objectStoreNames.contains("works")) {
            const ws = db.createObjectStore("works", { keyPath:"id", autoIncrement:true });
            ws.createIndex("personId", "personId", { unique:false });
        }
        if(!db.objectStoreNames.contains("logs")) {
            const ls = db.createObjectStore("logs", { keyPath:"id", autoIncrement:true });
            ls.createIndex("timestamp", "timestamp", { unique:false });
        }
    };
    req.onsuccess = (e) => { db = e.target.result; }; // Don't load list here to avoid flicker if dummy active
};

// ====================
// 2. NAVIGATION & HOME
// ====================
function navTo(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    
    if(tab === 'home') {
        document.getElementById('home-screen').style.display = 'block';
        document.querySelectorAll('.nav-item')[0].classList.add('active');
        loadHomeList();
    } else {
        document.getElementById('analysis-screen').style.display = 'block';
        document.querySelectorAll('.nav-item')[1].classList.add('active');
        loadAnalysis();
    }
}

function switchHomeMode(mode) {
    homeMode = mode;
    document.getElementById('btn-mode-people').className = mode==='people'?'mode-btn active':'mode-btn';
    document.getElementById('btn-mode-works').className = mode==='works'?'mode-btn active':'mode-btn';
    document.getElementById('home-title').innerText = mode==='people'?"MUSE LIST (Hold to Edit)":"LIBRARY (Tap to Detail)";
    loadHomeList();
}

function loadHomeList() {
    if(!db) return;
    const tx = db.transaction(["people", "works"], "readonly");
    const pStore = tx.objectStore("people");
    const wStore = tx.objectStore("works");
    
    Promise.all([
        new Promise(r => pStore.getAll().onsuccess = e => r(e.target.result)),
        new Promise(r => wStore.getAll().onsuccess = e => r(e.target.result))
    ]).then(([people, works]) => {
        const query = document.getElementById('search-input').value.toLowerCase();
        
        if(homeMode === 'people') {
            document.getElementById('home-list').style.display = 'grid';
            document.getElementById('home-list').style.visibility = 'visible'; // Ensure visibility
            document.getElementById('work-list-home').style.display = 'none';
            // Filter
            let filtered = people.filter(p => p.name.toLowerCase().includes(query));
            if(selectedTags.size > 0) {
                const isExact = document.getElementById('tag-exact-match').checked;
                filtered = filtered.filter(p => {
                    // Check person tags
                    const pTags = p.tags || [];
                    let pMatch = isExact ? Array.from(selectedTags).every(t=>pTags.includes(t)) : pTags.some(t=>selectedTags.has(t));
                    if(pMatch) return true;
                    // Check their works
                    const myWorks = works.filter(w=>w.personId===p.id);
                    return myWorks.some(w => {
                         const wTags = w.tags || [];
                         return isExact ? Array.from(selectedTags).every(t=>wTags.includes(t)) : wTags.some(t=>selectedTags.has(t));
                    });
                });
            }
            sortItems(filtered, sortState.home);
            renderCards(filtered, 'person', 'home-list');
        } else {
            document.getElementById('home-list').style.display = 'none';
            document.getElementById('work-list-home').style.display = 'grid';
            document.getElementById('work-list-home').style.visibility = 'visible';
            // Filter
            let filtered = works.filter(w => w.title.toLowerCase().includes(query));
            if(selectedTags.size > 0) {
                 const isExact = document.getElementById('tag-exact-match').checked;
                 filtered = filtered.filter(w => {
                    const wTags = w.tags || [];
                    return isExact ? Array.from(selectedTags).every(t=>wTags.includes(t)) : wTags.some(t=>selectedTags.has(t));
                 });
            }
            sortItems(filtered, sortState.home);
            renderCards(filtered, 'work', 'work-list-home');
        }
    });
}

function sortItems(arr, mode) {
    if(mode === 'count') arr.sort((a,b) => (b.count||0) - (a.count||0));
    else if(mode === 'newest') arr.sort((a,b) => b.id - a.id);
    else if(mode === 'rating') {
        arr.sort((a,b) => {
            const va = (a.hallOfFame?6:0) + (a.rating||0);
            const vb = (b.hallOfFame?6:0) + (b.rating||0);
            return vb - va;
        });
    }
}

// ====================
// 3. RENDERING CARDS (Simple Logic)
// ====================
function renderCards(items, type, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = "";
    if(items.length === 0) { container.innerHTML = "<div style='grid-column:span 2; text-align:center; color:#555;'>No Data</div>"; return; }

    items.forEach(item => {
        const div = document.createElement('div');
        div.className = type === 'person' ? 'person-card' : 'work-card';
        if(item.hallOfFame) div.classList.add('hof');
        
        let imgHtml = '<div class="thumb-placeholder">NO IMAGE</div>';
        if(item.image) {
            imgHtml = `<img src="${item.image}" style="object-position: ${item.focusX||50}% ${item.focusY||50}%">`;
        }
        let crown = item.hallOfFame ? '<div class="card-crown">üëë</div>' : '';
        let label = type==='person' ? item.name : item.title;
        
        // Stars for Works in Library Mode
        let sub = "";
        if(type === 'work' && item.rating > 0) {
            sub = '<div class="rating-stars-sm">';
            for(let i=0; i<item.rating; i++) sub += '<span class="on">‚òÖ</span>';
            sub += '</div>';
        }
        
        div.innerHTML = `
            <div class="thumb-area">${imgHtml}${crown}</div>
            <div class="info-area">
                <div class="${type==='person'?'name':'work-card-title'}">${label}</div>
                ${sub}
                <div class="count">${item.count||0} SELECTIONS</div>
            </div>
        `;

        // Interaction
        let pressTimer = null;
        div.addEventListener('touchstart', (e) => {
            div.classList.add('pressing');
            pressTimer = setTimeout(() => {
                pressTimer = null;
                if(navigator.vibrate) navigator.vibrate(40);
                div.classList.remove('pressing');
                if(type === 'person') openEditPerson(item); else openEditWork(item);
            }, 600);
        });
        div.addEventListener('touchend', () => {
            div.classList.remove('pressing');
            if(pressTimer) { clearTimeout(pressTimer); pressTimer = null; 
                if(type === 'person') openDetail(item.id); else openWorkDetail(item);
            }
        });
        div.addEventListener('touchmove', () => { if(pressTimer) { clearTimeout(pressTimer); pressTimer = null; div.classList.remove('pressing'); }});
        div.onclick = () => {
            if(!('ontouchstart' in window)) {
                if(type === 'person') openDetail(item.id); else openWorkDetail(item);
            }
        };
        div.oncontextmenu = (e) => { e.preventDefault(); if(type === 'person') openEditPerson(item); else openEditWork(item); }

        container.appendChild(div);
    });
}

// ====================
// 4. DETAIL SCREENS
// ====================
function openDetail(pid) {
    currentPersonId = pid;
    document.getElementById('home-screen').style.display = 'none';
    document.getElementById('detail-screen').style.display = 'flex';
    document.getElementById('detail-screen').classList.add('fade-in');
    
    const tx = db.transaction(["people", "works"], "readonly");
    tx.objectStore("people").get(pid).onsuccess = (e) => {
        const p = e.target.result;
        if(!p) return;
        document.getElementById('d-name').innerText = p.name;
        document.getElementById('d-stats').innerText = `Selection: ${p.count||0}`;
        document.getElementById('d-profile').innerText = p.profile || "";
        
        let specs = "";
        if(p.hallOfFame) specs += `<span class="detail-spec-item" style="color:#d4af37; border-color:#d4af37;">üëë Hall of Fame</span> `;
        if(p.cup) specs += `<span class="detail-spec-item">${p.cup} cup</span> `;
        if(p.birthday) {
            const age = getAge(p.birthday);
            specs += `<span class="detail-spec-item">${age}Ê≠≥ (${p.birthday.replace(/-/g,'/')})</span>`;
        }
        document.getElementById('d-specs').innerHTML = specs;
        const tDiv = document.getElementById('d-tags'); tDiv.innerHTML = "";
        if(p.tags) p.tags.forEach(t => tDiv.innerHTML += `<span class="tag">${t}</span>`);
        const img = document.getElementById('detail-bg');
        if(p.image) { img.src = p.image; img.style.objectPosition = `${p.focusX||50}% ${p.focusY||50}%`; }
        else img.src = "";
    };
    loadDetailWorks();
}

function loadDetailWorks() {
    const tx = db.transaction(["works"], "readonly");
    const idx = tx.objectStore("works").index("personId");
    idx.getAll(currentPersonId).onsuccess = (e) => {
        const works = e.target.result;
        sortItems(works, sortState.detail);
        renderDetailWorkList(works);
    };
}

function renderDetailWorkList(works) {
    const con = document.getElementById('detail-work-list'); con.innerHTML = "";
    if(works.length===0) { con.innerHTML="<div style='text-align:center; color:#555; margin-top:20px;'>No Works</div>"; return; }
    works.forEach(w => {
        const div = document.createElement('div');
        div.className = 'list-item';
        if(w.hallOfFame) div.classList.add('hof');
        let thumb = w.image ? `<img src="${w.image}" class="list-thumb" style="object-position:${w.focusX||50}% ${w.focusY||50}%">` : "";
        let crown = w.hallOfFame ? 'üëë ' : '';
        div.innerHTML = `${thumb}<div class="list-info"><div class="list-title">${crown}${w.title}</div><div class="work-count">‚ñ∂ ${w.count||0}</div></div><div class="play-btn" onclick="playWork(${w.id}); event.stopPropagation();">‚ñ∂</div>`;
        
        // List Item Interaction
        let pressTimer = null;
        div.addEventListener('touchstart', (e) => {
            if(e.target.classList.contains('play-btn')) return;
            div.classList.add('pressing');
            pressTimer = setTimeout(() => {
                pressTimer = null;
                if(navigator.vibrate) navigator.vibrate(40);
                div.classList.remove('pressing');
                openEditWork(w);
            }, 600);
        });
        div.addEventListener('touchend', () => {
            div.classList.remove('pressing');
            if(pressTimer) { clearTimeout(pressTimer); pressTimer = null; openWorkDetail(w); }
        });
        div.addEventListener('touchmove', () => { if(pressTimer) { clearTimeout(pressTimer); pressTimer = null; div.classList.remove('pressing'); }});
        div.onclick = (e) => { if(!('ontouchstart' in window) && !e.target.classList.contains('play-btn')) openWorkDetail(w); };
        con.appendChild(div);
    });
}

function closeDetail() {
    document.getElementById('detail-screen').style.display = 'none';
    document.getElementById('home-screen').style.display = 'flex';
    currentPersonId = null;
    loadHomeList();
}

function openWorkDetail(w) {
    document.getElementById('wd-title').innerText = w.title;
    document.getElementById('wd-meta').innerText = `Selection: ${w.count||0}`;
    const tDiv = document.getElementById('wd-tags'); tDiv.innerHTML = "";
    if(w.tags) w.tags.forEach(t => tDiv.innerHTML += `<span class="tag">${t}</span>`);
    const img = document.getElementById('wd-img'); const noImg = document.getElementById('wd-no-img');
    if(w.image) {
        img.src = w.image; img.style.objectPosition = `${w.focusX||50}% ${w.focusY||50}%`;
        img.style.display = 'block'; noImg.style.display = 'none';
    } else { img.style.display = 'none'; noImg.style.display = 'block'; }
    document.getElementById('wd-play').onclick = () => playWork(w.id);
    const link = document.getElementById('wd-link');
    if(w.url) { link.style.display = 'block'; link.onclick = () => window.open(w.url, '_blank'); }
    else { link.style.display = 'none'; }
    document.getElementById('work-detail-screen').style.display = 'flex';
}
function closeWorkDetail() { document.getElementById('work-detail-screen').style.display = 'none'; }

// ====================
// 5. ACTIONS
// ====================
function playWork(wid) {
    // If from Library Mode, we might not have currentPersonId
    const tx = db.transaction(["works", "people", "logs"], "readwrite");
    const wStore = tx.objectStore("works");
    const pStore = tx.objectStore("people");
    const lStore = tx.objectStore("logs");

    wStore.get(wid).onsuccess = (e) => {
        const w = e.target.result;
        if(!w) return;
        w.count = (w.count||0) + 1;
        wStore.put(w);
        
        pStore.get(w.personId).onsuccess = (pe) => {
            const p = pe.target.result;
            if(p) {
                p.count = (p.count||0) + 1;
                p.lastUsed = new Date();
                pStore.put(p);
                // Update stats UI
                if(currentPersonId === p.id && document.getElementById('detail-screen').style.display === 'flex') {
                    document.getElementById('d-stats').innerText = `Selection: ${p.count}`;
                }
            }
        };
        lStore.add({ personId: w.personId, workId: wid, timestamp: new Date() });
    };

    tx.oncomplete = () => {
        showToast();
        if(currentPersonId) loadDetailWorks();
        if(document.getElementById('work-detail-screen').style.display === 'flex') {
             document.getElementById('wd-meta').innerText = "Selection: Updated";
        }
    };
}

function randomPick() {
    const tx = db.transaction(["people"], "readonly");
    tx.objectStore("people").getAll().onsuccess = (e) => {
        const arr = e.target.result;
        if(arr.length === 0) return alert("No Muses.");
        const r = arr[Math.floor(Math.random() * arr.length)];
        openDetail(r.id);
    };
}

function toggleSort(ctx) {
    const m = document.getElementById(`sort-menu-${ctx}`);
    m.style.display = (m.style.display === 'block') ? 'none' : 'block';
}
function setSort(mode, ctx) {
    sortState[ctx] = mode;
    document.getElementById(`sort-menu-${ctx}`).style.display = 'none';
    if(ctx === 'home') loadHomeList(); else loadDetailWorks();
}
function filterHome() { loadHomeList(); }

// ====================
// 6. MODALS
// ====================
function openAddPerson() { clearForm('person'); document.getElementById('modal-person').style.display = 'flex'; }
function addPerson() { openAddPerson(); }
function addWork() { clearForm('work'); document.getElementById('modal-work').style.display = 'flex'; }
function openEditPerson(p) { fillForm('person', p); document.getElementById('modal-person').style.display = 'flex'; }
function openEditWork(w) { fillForm('work', w); document.getElementById('modal-work').style.display = 'flex'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function openSettings() { document.getElementById('modal-settings').style.display = 'flex'; }
function openTagFilter() { 
    loadFilterChips();
    document.getElementById('tag-filter-modal').style.display = 'flex'; 
}
function closeTagFilterModal() { document.getElementById('tag-filter-modal').style.display = 'none'; }

function clearForm(type) {
    if(type==='person') {
        document.getElementById('p-id').value = ""; document.getElementById('p-name').value = "";
        document.getElementById('p-cup').value = ""; document.getElementById('p-bday').value = "";
        document.getElementById('p-profile').value = ""; document.getElementById('p-tags').value = "";
        toggleHof('p-hof', 'p-hof-icon', false);
        document.getElementById('p-preview').style.display = 'none';
        document.getElementById('p-del-btn').style.display = 'none';
        loadTagSuggestions('person');
    } else {
        document.getElementById('w-id').value = ""; document.getElementById('w-title').value = "";
        document.getElementById('w-url').value = ""; document.getElementById('w-tags').value = "";
        setRating(0); toggleHof('w-hof', 'w-hof-icon', false);
        document.getElementById('w-preview').style.display = 'none';
        document.getElementById('w-del-btn').style.display = 'none';
        loadTagSuggestions('work');
    }
}
function fillForm(type, obj) {
    if(type==='person') {
        document.getElementById('p-id').value = obj.id; document.getElementById('p-name').value = obj.name;
        document.getElementById('p-cup').value = obj.cup||""; document.getElementById('p-bday').value = obj.birthday||"";
        document.getElementById('p-profile').value = obj.profile||""; 
        document.getElementById('p-tags').value = obj.tags?obj.tags.join(" "):"";
        toggleHof('p-hof', 'p-hof-icon', !!obj.hallOfFame);
        if(obj.image) { document.getElementById('p-preview').src = obj.image; document.getElementById('p-preview').style.display = 'block'; focusTemp={x:obj.focusX||50, y:obj.focusY||50}; updateFocusMarker('p-focus'); }
        else document.getElementById('p-preview').style.display = 'none';
        document.getElementById('p-del-btn').style.display = 'block';
        loadTagSuggestions('person');
    } else {
        document.getElementById('w-id').value = obj.id; document.getElementById('w-title').value = obj.title;
        document.getElementById('w-url').value = obj.url||""; 
        document.getElementById('w-tags').value = obj.tags?obj.tags.join(" "):"";
        setRating(obj.rating||0); toggleHof('w-hof', 'w-hof-icon', !!obj.hallOfFame);
        if(obj.image) { document.getElementById('w-preview').src = obj.image; document.getElementById('w-preview').style.display = 'block'; focusTemp={x:obj.focusX||50, y:obj.focusY||50}; updateFocusMarker('w-focus'); }
        else document.getElementById('w-preview').style.display = 'none';
        document.getElementById('w-del-btn').style.display = 'block';
        loadTagSuggestions('work');
    }
}

// Save/Delete
function submitPerson() {
    const id = document.getElementById('p-id').value; const name = document.getElementById('p-name').value;
    if(!name) return alert("Name required");
    const data = {
        name: name, cup: document.getElementById('p-cup').value, birthday: document.getElementById('p-bday').value,
        profile: document.getElementById('p-profile').value, tags: document.getElementById('p-tags').value.split(" ").filter(t=>t),
        hallOfFame: document.getElementById('p-hof').checked
    };
    const img = document.getElementById('p-preview');
    if(img.style.display==='block' && img.src.startsWith('data:')) { data.image = img.src; data.focusX = focusTemp.x; data.focusY = focusTemp.y; }
    
    const tx = db.transaction(["people"], "readwrite"); const store = tx.objectStore("people");
    if(id) store.get(parseInt(id)).onsuccess = (e) => { Object.assign(e.target.result, data); store.put(e.target.result); };
    else { data.count=0; data.createdAt = new Date(); store.add(data); }
    tx.oncomplete = () => { closeModal('modal-person'); loadHomeList(); };
}

function submitWork() {
    const id = document.getElementById('w-id').value; const title = document.getElementById('w-title').value;
    if(!title) return alert("Title required");
    const data = {
        title: title, url: document.getElementById('w-url').value, tags: document.getElementById('w-tags').value.split(" ").filter(t=>t),
        hallOfFame: document.getElementById('w-hof').checked, rating: ratingTemp
    };
    const img = document.getElementById('w-preview');
    if(img.style.display==='block' && img.src.startsWith('data:')) { data.image = img.src; data.focusX = focusTemp.x; data.focusY = focusTemp.y; }

    const tx = db.transaction(["works"], "readwrite"); const store = tx.objectStore("works");
    if(id) store.get(parseInt(id)).onsuccess = (e) => { Object.assign(e.target.result, data); store.put(e.target.result); };
    else { data.personId = currentPersonId; data.count=0; data.createdAt = new Date(); store.add(data); }
    tx.oncomplete = () => { closeModal('modal-work'); if(currentPersonId) loadDetailWorks(); };
}

function deletePerson() {
    const id = document.getElementById('p-id').value;
    if(confirm("Delete?")) {
        const tx = db.transaction(["people"], "readwrite");
        tx.objectStore("people").delete(parseInt(id));
        tx.oncomplete = () => { closeModal('modal-person'); loadHomeList(); };
    }
}
function deleteWork() {
    const id = document.getElementById('w-id').value;
    if(confirm("Delete?")) {
        const tx = db.transaction(["works"], "readwrite");
        tx.objectStore("works").delete(parseInt(id));
        tx.oncomplete = () => { closeModal('modal-work'); loadDetailWorks(); };
    }
}

// Helpers
function setRating(r) { ratingTemp = r; const s = document.querySelectorAll('#w-rating-ui span'); s.forEach((el,i) => { if(i<r) el.classList.add('on'); else el.classList.remove('on'); }); }
function toggleHof(cid, iid, force) {
    const cb = document.getElementById(cid); const ic = document.getElementById(iid);
    if(force !== undefined) cb.checked = force; else cb.checked = !cb.checked;
    if(cb.checked) ic.classList.add('active'); else ic.classList.remove('active');
}
function previewFile(input, imgId, focusId) {
    if(input.files && input.files[0]) {
        const r = new FileReader();
        r.onload = (e) => { document.getElementById(imgId).src = e.target.result; document.getElementById(imgId).style.display = 'block'; focusTemp = {x:50,y:50}; updateFocusMarker(focusId); };
        r.readAsDataURL(input.files[0]);
    }
}
function setFocus(e, imgId, focusId) {
    const img = document.getElementById(imgId); const rect = img.getBoundingClientRect();
    const x = ((e.clientX - rect.left)/rect.width)*100; const y = ((e.clientY - rect.top)/rect.height)*100;
    focusTemp = {x,y}; updateFocusMarker(focusId);
}
function updateFocusMarker(id) { const m = document.getElementById(id); m.style.left = focusTemp.x+"%"; m.style.top = focusTemp.y+"%"; m.style.display = 'block'; }
function getAge(b) { const d = new Date(b); const n = new Date(); let a = n.getFullYear() - d.getFullYear(); if(n.getMonth()<d.getMonth()||(n.getMonth()===d.getMonth()&&n.getDate()<d.getDate())) a--; return a; }
async function pasteUrl() { try { const t = await navigator.clipboard.readText(); document.getElementById('w-url').value = t; } catch(e) { alert("Paste manually"); } }
function showToast() { const t = document.getElementById('toast'); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }

// Tags
function loadTagSuggestions(type) {
    const con = document.getElementById(type==='person'?'p-tag-sugg':'w-tag-sugg'); con.innerHTML="";
    const tags = new Set();
    const storeName = type==='person'?'people':'works';
    const tx = db.transaction([storeName], "readonly");
    tx.objectStore(storeName).getAll().onsuccess = (e) => {
        e.target.result.forEach(i => { if(i.tags) i.tags.forEach(t => tags.add(t)); });
        Array.from(tags).sort().forEach(t => {
            const d = document.createElement('div'); d.className='tag-s-chip'; d.innerText = t;
            d.onclick = () => { const inp = document.getElementById(type==='person'?'p-tags':'w-tags'); let v = inp.value.trim(); if(!v.includes(t)) inp.value = v + (v?" ":"") + t; };
            con.appendChild(d);
        });
    };
}
function loadFilterChips() {
    const con = document.getElementById('filter-chips'); con.innerHTML = "";
    const tags = new Set();
    const storeName = homeMode==='people'?'people':'works';
    const tx = db.transaction([storeName], "readonly");
    tx.objectStore(storeName).getAll().onsuccess = (e) => {
        e.target.result.forEach(i => { if(i.tags) i.tags.forEach(t => tags.add(t)); });
        Array.from(tags).sort().forEach(t => {
            const d = document.createElement('div'); d.className = 'filter-chip' + (selectedTags.has(t)?' selected':'');
            d.innerText = t;
            d.onclick = () => { if(selectedTags.has(t)) selectedTags.delete(t); else selectedTags.add(t); loadFilterChips(); };
            con.appendChild(d);
        });
    };
}
function clearTagFilter() { selectedTags.clear(); loadFilterChips(); }
function applyTagFilter() { closeTagFilterModal(); loadHomeList(); }

// Analysis
function loadAnalysis() {
    const tx = db.transaction(["logs", "people", "works"], "readonly");
    let logs=[], people=[], works=[];
    Promise.all([
        new Promise(r=>tx.objectStore("logs").getAll().onsuccess=e=>r(e.target.result)),
        new Promise(r=>tx.objectStore("people").getAll().onsuccess=e=>r(e.target.result)),
        new Promise(r=>tx.objectStore("works").getAll().onsuccess=e=>r(e.target.result))
    ]).then(res => {
        logs=res[0]; people=res[1]; works=res[2];
        let total = 0; people.forEach(p=>total+=(p.count||0));
        document.getElementById('total-count').innerText = total + " times";
        
        // Calendar
        const grid = document.getElementById('cal-grid'); grid.innerHTML = "";
        const now = new Date(); const today = now.getDate();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
        const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
        const activeDays = new Set(logs.filter(l=>new Date(l.timestamp).getMonth()===now.getMonth()).map(l=>new Date(l.timestamp).getDate()));
        for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
        for(let d=1; d<=daysInMonth; d++) {
            const c = document.createElement('div'); c.className = 'cal-day'; c.innerText = d;
            if(activeDays.has(d)) c.classList.add('active');
            if(d===today) c.classList.add('today');
            grid.appendChild(c);
        }

        // Pie
        const pieCon = document.getElementById('pie-rated'); pieCon.innerHTML = "";
        const highTags = {}; let hTotal = 0;
        works.forEach(w => { if((w.rating>=4 || w.hallOfFame) && w.tags) w.tags.forEach(t=>{ highTags[t]=(highTags[t]||0)+1; hTotal++; }); });
        if(hTotal>0) {
            const sorted = Object.entries(highTags).sort((a,b)=>b[1]-a[1]).slice(0,5);
            let grad = "", deg = 0, leg = '<div class="pie-legend">';
            const cols = ['#d4af37','#b89630','#8a7024','#5e4d1a','#333'];
            sorted.forEach((item, i) => {
                const d = (item[1]/hTotal)*360; const c = cols[i]||'#333';
                grad += `${c} ${deg}deg ${deg+d}deg, `; deg += d;
                leg += `<div class="legend-item"><div class="legend-color" style="background:${c}"></div>${item[0]}</div>`;
            });
            const ch = document.createElement('div'); ch.className='pie-chart'; ch.style.background=`conic-gradient(${grad.slice(0,-2)})`;
            ch.innerHTML = `<div class="pie-hole"><div style="font-size:10px; color:#888;">TOP RATED</div><div style="font-size:14px; color:#d4af37;">${hTotal}</div></div>`;
            pieCon.appendChild(ch); pieCon.insertAdjacentHTML('beforeend', leg+'</div>');
        } else pieCon.innerHTML = "<div style='color:#555; font-size:10px;'>No Data</div>";

        // Champion
        let champ = people.sort((a,b)=>(b.count||0)-(a.count||0))[0];
        if(champ && champ.count > 0) {
            const area = document.getElementById('champion-area');
            const fStyle = `object-position: ${champ.focusX||50}% ${champ.focusY||50}%`;
            area.innerHTML = `
                <div class="champion-box" onclick="openDetail(${champ.id})">
                    <div class="champion-title">QUEEN OF THE MONTH</div>
                    <div class="champion-img-container"><div class="champion-bg-flower"></div><div class="champion-crown">üëë</div><img src="${champ.image||''}" class="champion-img" style="${champ.image?'':'background:#333'}; ${fStyle}"></div>
                    <div class="champion-name">${champ.name}</div>
                    <div class="champion-score">${champ.count} Selections</div>
                </div>`;
            area.style.display = 'block';
        }

        // Ranking Lists
        renderRankList(people, 'person-tag-ranking', 'tags');
        renderRankList(works, 'tag-ranking', 'tags');
        renderRankList(people, 'ranking-list', 'people');
    });
}

function renderRankList(items, id, mode) {
    const con = document.getElementById(id); con.innerHTML = "";
    if(mode === 'people') {
        items.slice(0,5).forEach((x, i) => {
            const r = document.createElement('div'); r.className='rank-item';
            r.innerHTML = `<div class="rank-num">#${i+1}</div><div class="rank-name">${x.name}</div><div class="rank-count">${x.count||0}</div>`;
            con.appendChild(r);
        });
    } else {
        const counts = {}; let total = 0;
        items.forEach(x => { if(x.tags && (x.count > 0 || mode==='tags')) x.tags.forEach(t=>{ counts[t]=(counts[t]||0)+(x.count||1); total+=(x.count||1); }); });
        const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5);
        if(sorted.length===0) { con.innerHTML="<div style='color:#555; text-align:center; font-size:10px;'>No Data</div>"; return; }
        const max = sorted[0][1];
        sorted.forEach(s => {
            const d = document.createElement('div'); d.className='tag-bar';
            d.innerHTML = `<div class="tag-label">${s[0]}</div><div class="tag-track"><div class="tag-fill" style="width:${(s[1]/max)*100}%"></div></div><div class="tag-val">${s[1]}</div>`;
            con.appendChild(d);
        });
    }
}

// Backup
function exportData() {
    const tx = db.transaction(["people", "works", "logs"], "readonly");
    const data = {};
    const reqs = [
        new Promise(r=>tx.objectStore("people").getAll().onsuccess=e=>r(data.people=e.target.result)),
        new Promise(r=>tx.objectStore("works").getAll().onsuccess=e=>r(data.works=e.target.result)),
        new Promise(r=>tx.objectStore("logs").getAll().onsuccess=e=>r(data.logs=e.target.result))
    ];
    Promise.all(reqs).then(()=>{
        const b = new Blob([JSON.stringify(data)],{type:"application/json"});
        const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`museum_backup.json`; a.click();
    });
}
function restoreData(input) {
    if(!input.files[0] || !confirm("Overwrite?")) return;
    const r = new FileReader();
    r.onload = (e) => {
        const d = JSON.parse(e.target.result);
        const tx = db.transaction(["people", "works", "logs"], "readwrite");
        tx.objectStore("people").clear(); d.people.forEach(i=>tx.objectStore("people").add(i));
        tx.objectStore("works").clear(); d.works.forEach(i=>tx.objectStore("works").add(i));
        tx.objectStore("logs").clear(); d.logs.forEach(i=>tx.objectStore("logs").add(i));
        tx.oncomplete = () => { alert("Restored"); location.reload(); };
    };
    r.readAsText(input.files[0]);
}
function wipeData() {
    if(confirm("Wipe all?")) {
        const tx = db.transaction(["people", "works", "logs"], "readwrite");
        tx.objectStore("people").clear(); tx.objectStore("works").clear(); tx.objectStore("logs").clear();
        tx.oncomplete = () => location.reload();
    }
}
</script>
</body>
</html>
